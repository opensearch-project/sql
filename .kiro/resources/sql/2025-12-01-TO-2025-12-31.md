# PR Review Data: opensearch-project/sql
**Date Range:** 2025-12-01 to 2025-12-31
**Total PRs:** 66
**Generated:** 2026-01-21T14:22:45.308730

---

# PR #5009: Fix PIT context leak in Legacy SQL for non-paginated queries

**URL:** https://github.com/opensearch-project/sql/pull/5009

**Author:** @aalva500-prog

**Created:** 2025-12-31T23:19:12Z

**State:** MERGED

**Merged:** 2026-01-08T22:59:29Z

**Changes:** +387 -50 (4 files)

**Labels:** `backport-manually`, `backport-failed`, `backport 2.19-dev`, `backport 3.1`, `bugFix`


## Description

### Description
This PR fixes Point-in-Time (PIT) context leak in the Legacy SQL engine when executing queries without `fetch_size` parameter.

**Problem:**
The Legacy SQL engine was creating PIT contexts for ALL queries but only cleaning them up when cursors were created (paginated queries with `fetch_size > 0`). Non-paginated queries leaked PITs, causing accumulation until the 300 PIT limit was exhausted and queries to fail.

**Solution:**
- Only create PIT when `fetch_size > 0` and not `null`  (pagination requested)

**Impact:**
- Non-paginated queries no longer leak PIT contexts
- Paginated queries continue to work correctly with cursor-based PIT management

### Related Issues
Resolves #5002

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @dai-chen - DISMISSED


Thanks for the fix!


## Review Comments


### @aalva500-prog on `integ-test/src/test/java/org/opensearch/sql/legacy/PointInTimeLeakIT.java:100`


Wrong suggestion, there is no compilation error as the executeCursorCloseQuery method is not missing - it's already implemented in the parent class SQLIntegTestCase and is being correctly inherited by PointInTimeLeakIT.


### @aalva500-prog on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


Will take care of it


### @aalva500-prog on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


Will take care of it


### @Swiddis on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


issue (non-blocking): Why do we need this catch block? The finally block does the same thing?


### @Swiddis on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


issue (readability): It's not obvious how this logic avoids deleting the cursor for paginated queries.

`cursorCreated` could stand to be more clearly named, and all the cursor config could be split out to a smaller method to make it easier to follow this branching. `isDefaultCursor` isn't a very descriptive name either


### @aalva500-prog on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


I'll remove the catch block and leave the finally block, thanks!


### @aalva500-prog on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


Sure, will simplify the implementation and make it more readable, thanks!


### @dai-chen on `integ-test/src/test/java/org/opensearch/sql/legacy/PointInTimeLeakIT.java:None`


Please remove all sysout


### @dai-chen on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


Could you separate the logic in 2 methods instead of flow control by this flag?


### @dai-chen on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:99`


What is this used for?


### @dai-chen on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


Not necessary because finally block will executed anyway?


### @aalva500-prog on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


Yeah, I'm fixing it, thanks!


### @vamsimanohar on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:102`


can you explain the logic here in words? What does fetchsize mean here?


### @aalva500-prog on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


Sure, I'm working on it, thanks!


### @aalva500-prog on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:102`


fetchsize is the size of the fetch_size parameter of the query, I'm only creating a PIT if the user specifies the fetch_size parameter and it is greater than zero. Before this, the PIT was always created regardless the user providing fetchsize in the query or not. My logic is to avoid creating PIT if `fetchSize` is 0 or not specified, meaning no pagination is needed and no PIT is created. Hope that makes sense.



### @aalva500-prog on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:99`


It was originally in the code, will take a further look and update here, thanks!

__Update:__ Ran the integration tests without this line and got failures in `CursorIT`, `PrettyFormatResponseIT`, `SQLCorrectnessIT`, `PaginationFallbackIT`, and `PaginationIT`.

According to my investigation, the call to `queryAction.explain()` is necessary because it builds the OpenSearch `SearchRequestBuilder` before executing the query. Without it, the `request` field in `DefaultQueryAction` remains null, which causes failures when `queryAction.getRequestBuilder()` is called later.

The original code was:

```java
SqlOpenSearchRequestBuilder sqlOpenSearchRequestBuilder = queryAction.explain();
```

Since the returned variable is never used, I simplified it to:

```java
queryAction.explain();
```


### @dai-chen on `integ-test/src/test/java/org/opensearch/sql/legacy/PointInTimeLeakIT.java:None`


np: I recall org.json supports JSON path. Could you check `query()` or `optQuery()` API?


### @dai-chen on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/PrettyFormatRestExecutor.java:None`


Thanks for the refactor. It looks much cleaner!


### @aalva500-prog on `integ-test/src/test/java/org/opensearch/sql/legacy/PointInTimeLeakIT.java:None`


Sure, I'll modify this method accordingly, thanks!


## General Comments


### @vamsimanohar


Have you also checked in other scenarios if the PIT contexts are closed properly


### @aalva500-prog


> Have you also checked in other scenarios if the PIT contexts are closed properly

@vamsimanohar The PIT context leak only happens in Legacy engine when the index name has special characters like `test-logs-2025.01.01`, it is not wrapped in backticks, and the fecth_size is not provided. It doesn't happen when the index name is like `test-logs-2025-01-01`, as it never falls to Legacy engine and it is handled by V2/V3. The IT class `PointInTimeLeakIT` should cover such scenarios, specifically this test case `testCompareV1AndV2EnginePitBehavior` compares V1 vs V2 by using backticks around the index so that the query is handle by V2 only. Note: I did manual testing in my own local cluster and AOS domain to confirm the same.


---

# PR #5007: [Backport 2.19-dev] adding capability in SQLQueryUtils to identify if SQL query is for creating a table or not

**URL:** https://github.com/opensearch-project/sql/pull/5007

**Author:** @Parasjg

**Created:** 2025-12-30T07:45:44Z

**State:** MERGED

**Merged:** 2026-01-07T02:21:32Z

**Changes:** +100 -7 (2 files)


## Description

BackPorting Already Merged PR (https://github.com/opensearch-project/sql/pull/4029) - https://github.com/opensearch-project/sql/commit/5cb51814ed1bb527c47a5e827c773a1899c081e9
from main to 2.19-dev
### Description
Adding capability in SQLQueryUtils to identify if SQL query is for creating a table or not.

### Related Issues
Resolves #[Issue number to be closed when this PR is merged]

### Check List
- [NA] New functionality has been documented.
 - [NA] New functionality has javadoc added.
 - [NA] New functionality has a user manual doc added.
- [NA] New PPL command [checklist](https://github.com/opensearch-project/sql/blob/main/docs/dev/ppl-commands.md) all confirmed.
- [NA] API changes companion pull request [created](https://github.com/opensearch-project/opensearch-api-specification/blob/main/DEVELOPER_GUIDE.md).
- [NA] Public documentation issue/PR [created](https://github.com/opensearch-project/documentation-website/issues/new/choose).

By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #5003: [Backport 2.19-dev] Support enumerable TopK

**URL:** https://github.com/opensearch-project/sql/pull/5003

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-29T07:08:42Z

**State:** MERGED

**Merged:** 2025-12-29T09:32:07Z

**Changes:** +334 -217 (39 files)


## Description

Backport 08be6f92fecdf6ea14cbcb38762677e2dcfcf85d from #4993.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #5000: [Backport 2.19-dev] Prune old in operator push down rules (#4992)

**URL:** https://github.com/opensearch-project/sql/pull/5000

**Author:** @qianheng-aws

**Created:** 2025-12-26T09:41:39Z

**State:** MERGED

**Merged:** 2025-12-29T06:24:06Z

**Changes:** +471 -385 (110 files)


## Description

(cherry picked from https://github.com/opensearch-project/sql/pull/4992 commit https://github.com/opensearch-project/sql/commit/0ecb0a95b252401474d78fb45abafa30cb31453d)



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4997: Apply feedback from documentation-website to PPL command docs

**URL:** https://github.com/opensearch-project/sql/pull/4997

**Author:** @ritvibhatt

**Created:** 2025-12-24T23:43:31Z

**State:** MERGED

**Merged:** 2026-01-09T17:29:20Z

**Changes:** +4354 -3422 (60 files)

**Labels:** `documentation`, `enhancement`


## Description

### Description
- Apply feedback from technical writers from documentation-website PR (https://github.com/opensearch-project/documentation-website/pull/11688) to SQL repo to keep documentation in sync 
- Update script to auto-convert codeblock tables to markdown tables, support single directory export, remove empty tables, improve Jekyll angle bracket/asterisk escaping, convert markdown emphasis to Jekyll attributes
- Add README with SOP for docs exporter script

When the docs exporter script is applied now, the differences from the docs website are: links to sections not yet ported to documentation-website are commented out in the docs website (functions, admin), whitespace differences, different nav order for some command files, and some differences in escape characters for angle brackets and asterisks. Everything except the commented out admin links will be addressed in the next documentation-website PR (https://github.com/opensearch-project/documentation-website/pull/11747).

### Related Issues
Resolves #[Issue number to be closed when this PR is merged]
<!-- List any other related issues here -->

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


### @kylehounslow


Thanks @ritvibhatt! Does this PR enable zero diff when re-exporting back to `documentation-website`? Or are there manual changes that need to happen?


### @ritvibhatt


> When the docs exporter script is applied now, the differences from the docs website are: links to sections not yet ported to documentation-website are commented out in the docs website (functions, admin), whitespace differences, different nav order for some command files, and some differences in escape characters for angle brackets and asterisks. Everything except the commented out admin links will be addressed in the next documentation-website PR ([opensearch-project/documentation-website#11747](https://github.com/opensearch-project/documentation-website/pull/11747)).

@kylehounslow It still has a few differences right now:
- links to sections not yet ported to documentation-website are commented out in the docs website (functions, admin)
- some whitespace differences and different nav order for some command files (looks like documentation website skips some numbers for nav order)
- some differences with adding escape characters for angle brackets and asterisks (causing some problems with examples rendering in documentation website)
Raised another PR for the documentation website that should address everything except the commented out admin links: https://github.com/opensearch-project/documentation-website/pull/11747.



---

# PR #4996: Sync up this path publish-async-query-core.yml from main to 2.19-dev and also changing the JAVA to 17

**URL:** https://github.com/opensearch-project/sql/pull/4996

**Author:** @Parasjg

**Created:** 2025-12-24T10:13:26Z

**State:** MERGED

**Merged:** 2026-01-06T17:46:57Z

**Changes:** +17 -7 (2 files)


## Description

Sync up this path publish-async-query-core.yml from main to 2.19-dev and also changing the JAVA to 17

### Description
Sync up this path publish-async-query-core.yml from main to 2.19-dev and also changing the JAVA to 17

### Related Issues
Resolving issue related to java version when upadating the async-query-core jars in DQS

### Check List
- [NA] New functionality includes testing.
- [NA] New functionality has been documented.
 - [NA] New functionality has javadoc added.
 - [NA] New functionality has a user manual doc added.
- [NA] New PPL command [checklist](https://github.com/opensearch-project/sql/blob/main/docs/dev/ppl-commands.md) all confirmed.
- [NA] API changes companion pull request [created](https://github.com/opensearch-project/opensearch-api-specification/blob/main/DEVELOPER_GUIDE.md).
- [NA] Public documentation issue/PR [created](https://github.com/opensearch-project/documentation-website/issues/new/choose).

By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @ahkcs - APPROVED


LGTM


## Review Comments


### @LantaoJin on `.github/workflows/publish-async-query-core.yml:38`


shouldn't be 11 for 2.19?


### @Parasjg on `.github/workflows/publish-async-query-core.yml:38`


We connected with Kai Huang , he suggested 17 could work . Do let me know if we can't go ahead with this one.


### @ahkcs on `.github/workflows/publish-async-query-core.yml:38`


We want to use JDK 17 for async query core jar here and main branch doesn't support 17, that's why I suggested them to backport the maven snapshot upload logic to 2.19-dev branch with JDK 17 supported, please let me know if there's any concerns for this


## General Comments


_No general comments from humans_


---

# PR #4995: [Backport 2.19-dev] Dedup pushdown (TopHits Agg) should work with Object fields (#4991)

**URL:** https://github.com/opensearch-project/sql/pull/4995

**Author:** @LantaoJin

**Created:** 2025-12-24T09:07:32Z

**State:** MERGED

**Merged:** 2025-12-26T07:31:16Z

**Changes:** +53 -27 (6 files)


## Description

(cherry picked from #4991 commit 1192376a7b0856375b3dbea6c54ed3420e593b7d)



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4993: Support enumerable TopK

**URL:** https://github.com/opensearch-project/sql/pull/4993

**Author:** @LantaoJin

**Created:** 2025-12-23T12:14:09Z

**State:** MERGED

**Merged:** 2025-12-29T06:43:07Z

**Changes:** +334 -217 (39 files)

**Labels:** `enhancement`, `backport 2.19-dev`


## Description

### Description
Support enumerable TopK, check #4982 for issue details.

- EnumerableTopKConverterRule
  - Convert `LogicalSort` with `fetch` to `CalciteEnumerableTopK`
-  EnumerableTopKMergeRule
   - Merge `EnumerableLimit` and `EnumerableSort` to `CalciteEnumerableTopK`


The `CalciteEnumerableTopK` is derived from `EnumerableLimitSort` which has the corrected cost computation.

### Related Issues
Resolves #4982 

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @yuancu - DISMISSED


LGTM


## Review Comments


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/EnumerableTopKRule.java:None`


Do we need copy the license from Calcite? 


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite/explain_dedup_with_expr4.yaml:None`


change `{"field":"state.keyword","missing_bucket":false,"order":"asc"}` to`{"field":"state.keyword","missing_bucket":false,"order":"desc"}`


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite/explain_dedup_with_expr4_alternative.yaml:None`


ditto


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/EnumerableTopKRule.java:None`


No, I think. it's not 100% copy


### @yuancu on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/OpenSearchIndexRules.java:43`


Can `ENUMERABLE_TOP_K_RULE` be eliminated with `ENUMERABLE_TOP_K_MERGE_RULE`?

It seems the former converts limit+sort from logical to enumerable top-k, while the latter converts limit+sort from enumerable ones to enumerable top-k. But the former will be converted to limit+sort enumerable plan if without the converter rule. The merge rule seem to cover this case


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/OpenSearchIndexRules.java:43`


No before #4992 , let me try it now, will remove it if no explain case fails


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/OpenSearchIndexRules.java:43`


Thanks 4992, removing EnumerableTopKConverterRule works now.


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/storage/scan/CalciteLogicalIndexScan.java:440`


[question] Curious when and how could it happens with this change?


### @qianheng-aws on `integ-test/src/test/resources/expectedOutput/calcite/explain_dedup_with_expr4.yaml:None`


Shall we prevent push down `CalciteEnumerableTopK` in `SortIndexScanRule`?   I think we should only push down an `EnumerableSort`  for a  physical level plan.


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/physical/CalciteEnumerableTopK.java:20`


Missing Override `copy` method. If not, this class will downgrade to its parent later when do copy.


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/storage/scan/CalciteLogicalIndexScan.java:440`


The issue seems only happens without pruning. Now I cannot reproduce it. But for multisearch test `testExplainMultisearchTimestampInterleaving`, we can remove the second duplicated LIMIT pushdown: `LIMIT->5, LIMIT->5`. We can keep this logic.



### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/physical/CalciteEnumerableTopK.java:20`


added


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/physical/CalciteEnumerableTopK.java:20`


> Missing Override `copy` method. If not, this class will downgrade to its parent later when do copy.

@coderabbitai This is a good finding. Can you learn something from it?


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite/explain_dedup_with_expr4.yaml:None`


fixed


## General Comments


### @LantaoJin


Let's suspend on merging until https://github.com/opensearch-project/sql/pull/4992 merged


---

# PR #4992: Prune old in operator push down rules

**URL:** https://github.com/opensearch-project/sql/pull/4992

**Author:** @qianheng-aws

**Created:** 2025-12-23T08:45:47Z

**State:** MERGED

**Merged:** 2025-12-26T07:30:22Z

**Changes:** +451 -384 (110 files)

**Labels:** `enhancement`, `backport-manually`, `backport-failed`, `backport 2.19-dev`


## Description

### Description
This PR primally supports pruning the old operator if we get a better plan than before. Therefore, it will improve the efficiency of planning process by avoid exploring meaningless equivalent plans.

The performance gain is shown below:
1. Average query cost on big5 and clickbench:

  | previous | pruneOld
-- | -- | --
big5 | 17ms | 14ms
clickbench | 26 ms | 19ms

2. Average optimization cost on big5 and clickbench (By enable calcite's debug mode and adding timingTracer, it will induce more time cost than before)


  | previous | pruneOld
-- | -- | --
big5 | 36.3 ms | 25.9 ms
clickbench | 265 ms | 110.9 ms

3. Average number of applied rules on big5 and clickbench:


  | previous | pruneOld
-- | -- | --
big5 | 114 | 50
clickbench | 474 | 215

Some positive cases on plan with this PR:
- testDedupRename
- testCasePushdownAsRangeQueryExplain
- testExplainOnAggregationWithFunction
- testDedupExpr

### Implementation Details

As described in https://github.com/opensearch-project/sql/issues/4931#issuecomment-3645518565, there is also many issues and bug spotted after pruning old. So there is additional change to fix them and make it compatible:

- As there is Subset reuse in Calcite, pruning a Subset which is the only child of other Subset will cause preparing failure. So we should prune the old from top to down and stop if the current node cannot be pruned. One node cannot be pruned if it's physical node(see the point5 in the above comment) or it has multiple parents(except the root of the call, as we are generating a new root to replace it).
- Make `PPLAggregateConvertRule`, `PPLAggGroupMergeRule`, 'RareTopPushdownRule', 'DedupPushDownRule'  implements `SubstitutionRule` so they will get higher priority on rule match and then we can get optimized aggregates in RelSubset before pruning.
- Support removing `project`, `sort` and agg derived `filter` when doing aggregate push down.
- Slightly refactor `AggregateIndexScanRule` so it can support pushing down on more cases
- Refactor and simplify `DedupPushDownRule` so it can get compatible with the current pruning mechanism
- Continue pushing down limit if it can reduce the estimated row count.
- Fix several bugs in `AggregateAnalyzer` when the project is null. See UT in `AggregateAnalyzerTest`, its expected results is wrong before. 

### Related Issues
Resolves https://github.com/opensearch-project/sql/issues/4931

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @LantaoJin - COMMENTED


I'd like to verify the checksum of clickbench result before being merged


## Review Comments


### @yuancu on `core/src/main/java/org/opensearch/sql/calcite/utils/PlanUtils.java:746`


How does the condition `volcanoPlanner.getSubsetNonNull(rel).getParentRels().size() == 1` guarantee that the rel node's parent is pruned?

Is it because that if the index is greater than 0, then index 0 must have been traversed?


### @yuancu on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:36`


Why do some rules implement `SubstitutionRule`, while some don't?




### @LantaoJin on `core/src/main/java/org/opensearch/sql/calcite/plan/PPLAggGroupMergeRule.java:47`


should be wrapped in `InterruptibleRelRule`?
```
public class PPLAggGroupMergeRule extends InterruptibleRelRule<PPLAggGroupMergeRule.Config> implements SubstitutionRule
```


### @LantaoJin on `core/src/main/java/org/opensearch/sql/calcite/plan/PPLAggGroupMergeRule.java:107`


how about move `tryPruneRelNodes(call)` into `InterruptibleRelRule`?
```
    onMatchImpl(call);
+   if (this instanceof SubstitutionRule) {
+     tryPruneRelNodes(call);
+   }
```



### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite/clickbench/q17.yaml:11`


Critical: the original query is `count() by UserID, SearchPhrase`, the order matter for results


### @yuancu on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:208`


I'm curious why can this rule be safely eliminated


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite/clickbench/q18.yaml:11`


ditto


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite/explain_agg_with_script.yaml:10`


Critical: Seems a bad case? the group key is an expression which should be pushed to script agg pushdown


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:36`


Good question! We need to update dev-doc to explain how to choose proper base rule.


### @qianheng-aws on `core/src/main/java/org/opensearch/sql/calcite/utils/PlanUtils.java:746`


Yes, if the current RelNode has only 1 parent, it must be the RelNode in `call.rels[current_offset - 1]` and it has been pruned in the previous step of this stream


### @qianheng-aws on `core/src/main/java/org/opensearch/sql/calcite/utils/PlanUtils.java:746`


The best way is looking up its all parents in `VolcanoPlanner.prunedNodes` while its unaccessible


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:208`


I refactor the dedup push down rule by unifying 2 rules into 1.


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:36`


Basically, we can only add `SubstitutionRule` if we can ensure it's better than the previous ones. As said in Calcite's comment for `SubstitutionRule`

> A rule that implements this interface indicates that the new RelNode is typically better than the old one.


### @qianheng-aws on `core/src/main/java/org/opensearch/sql/calcite/plan/PPLAggGroupMergeRule.java:107`


As discussed offline, `prune old` shouldn't forcefully be bound to `SubstitutionRule`.  Keep flexibility currently.


### @qianheng-aws on `integ-test/src/test/resources/expectedOutput/calcite/explain_agg_with_script.yaml:10`


This is a good case of applying `PPLAggGroupMergeRule`.


### @qianheng-aws on `integ-test/src/test/resources/expectedOutput/calcite/clickbench/q17.yaml:11`


In SQL, `group by a, b` is equivalent to `group by b, a`, many logic follows this principle in Calcite. And this is case is affected by `AggregateProjectMergeRule` in Calcite.


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/request/AggregateAnalyzer.java:186`


add `private`


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/request/AggregateAnalyzer.java:190`


ditto


### @qianheng-aws on `core/src/main/java/org/opensearch/sql/calcite/plan/PPLAggGroupMergeRule.java:47`


InterruptibleRelRule is in package `opensearch` and has dependency on `OpenSearchTimeoutException` while this rule is package `core`.

Therefore, we cannot make this extends `InterruptibleRelRule` unless move that from  package `opensearch` to `core` and add library `opensearch` in core gradle.

On the other hand, if there is interrupt triggered in planning process, it should be detected in our push down rules in package `opensearch`.


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/request/AggregateAnalyzer.java:186`


We should give the methods in `AggregateBuilderHelper` package level accessibility. I see all methods in this class are using default symbol


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite/explain_dedup_with_expr4.yaml:12`


It's odd why this IT passed with `{"field":"state.keyword","missing_bucket":false,"order":"asc"}}}]}`

It should be `desc`


### @qianheng-aws on `integ-test/src/test/resources/expectedOutput/calcite/explain_dedup_with_expr4.yaml:12`


ASC is the default order. SORT is removed as it’s before DEDUP


## General Comments


_No general comments from humans_


---

# PR #4991: Dedup pushdown (TopHits Agg) should work with Object fields

**URL:** https://github.com/opensearch-project/sql/pull/4991

**Author:** @LantaoJin

**Created:** 2025-12-23T08:03:13Z

**State:** MERGED

**Merged:** 2025-12-24T07:26:59Z

**Changes:** +53 -27 (6 files)

**Labels:** `backport-manually`, `backport-failed`, `backport 2.19-dev`, `bugFix`


## Description

### Description
#4844 converted `dedup` to TopHits Agg. But failed to parse dedup column if the column is a child of Object field.
#4360 restored the internal primitive value in a Map for Aggregates (first, last, min, max) which stored these Map objects in their accumulators.(first, last, min, max) stored these Map objects in their accumulators. But this fixing was not necessary since #4844 fixed them in other way.

In this PR:
1. fix the bug of get the dedup column names
2. revert #4360 

### Related Issues
Resolves #4990

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @yuancu - APPROVED


LGTM


## Review Comments


### @aalva500-prog on `integ-test/src/test/resources/expectedOutput/calcite/big5/dedup_metrics_size_field.yaml:1`


Hi @LantaoJin, thank you for the changes. The `dedup` command now works, but looks like the query execution plan changed. Looks like it now includes a PROJECT pushdown optimization:

```
curl -X POST "localhost:9200/_plugins/_ppl/_explain" \
-H "Content-Type: application/json" \
-d '{
"query": "source = big5 | dedup metrics.size | sort - @timestamp"          
}'
{
  "calcite": {
    "logical": "LogicalSystemLimit(sort0=[$7], dir0=[DESC-nulls-last], fetch=[10000], type=[QUERY_SIZE_LIMIT])\n  LogicalProject(agent=[$0], process=[$6], log=[$8], message=[$11], tags=[$12], cloud=[$13], input=[$15], @timestamp=[$17], data_stream=[$18], host=[$22], metrics=[$24], aws=[$27], event=[$32])\n    LogicalSort(sort0=[$17], dir0=[DESC-nulls-last])\n      LogicalProject(agent=[$0], agent.ephemeral_id=[$1], agent.id=[$2], agent.name=[$3], agent.type=[$4], agent.version=[$5], process=[$6], process.name=[$7], log=[$8], log.file=[$9], log.file.path=[$10], message=[$11], tags=[$12], cloud=[$13], cloud.region=[$14], input=[$15], input.type=[$16], @timestamp=[$17], data_stream=[$18], data_stream.dataset=[$19], data_stream.namespace=[$20], data_stream.type=[$21], host=[$22], host.name=[$23], metrics=[$24], metrics.size=[$25], metrics.tmin=[$26], aws=[$27], aws.cloudwatch=[$28], aws.cloudwatch.ingestion_time=[$29], aws.cloudwatch.log_group=[$30], aws.cloudwatch.log_stream=[$31], event=[$32], event.dataset=[$33], event.id=[$34], event.ingested=[$35], _id=[$36], _index=[$37], _score=[$38], _maxscore=[$39], _sort=[$40], _routing=[$41])\n        LogicalFilter(condition=[<=($42, 1)])\n          LogicalProject(agent=[$0], agent.ephemeral_id=[$1], agent.id=[$2], agent.name=[$3], agent.type=[$4], agent.version=[$5], process=[$6], process.name=[$7], log=[$8], log.file=[$9], log.file.path=[$10], message=[$11], tags=[$12], cloud=[$13], cloud.region=[$14], input=[$15], input.type=[$16], @timestamp=[$17], data_stream=[$18], data_stream.dataset=[$19], data_stream.namespace=[$20], data_stream.type=[$21], host=[$22], host.name=[$23], metrics=[$24], metrics.size=[$25], metrics.tmin=[$26], aws=[$27], aws.cloudwatch=[$28], aws.cloudwatch.ingestion_time=[$29], aws.cloudwatch.log_group=[$30], aws.cloudwatch.log_stream=[$31], event=[$32], event.dataset=[$33], event.id=[$34], event.ingested=[$35], _id=[$36], _index=[$37], _score=[$38], _maxscore=[$39], _sort=[$40], _routing=[$41], _row_number_dedup_=[ROW_NUMBER() OVER (PARTITION BY $25)])\n            LogicalFilter(condition=[IS NOT NULL($25)])\n              CalciteLogicalIndexScan(table=[[OpenSearch, big5]])\n",
    "physical": "EnumerableLimit(fetch=[10000])\n  EnumerableSort(sort0=[$7], dir0=[DESC-nulls-last])\n    CalciteEnumerableIndexScan(table=[[OpenSearch, big5]], PushDownContext=[[PROJECT->[agent, process, log, message, tags, cloud, input, @timestamp, data_stream, host, metrics, metrics.size, aws, event], AGGREGATION->rel#2183:LogicalAggregate.NONE.[](input=LogicalProject#2181,group={0},agg#0=LITERAL_AGG(1))], OpenSearchRequestBuilder(sourceBuilder={\"from\":0,\"size\":0,\"timeout\":\"1m\",\"_source\":{\"includes\":[\"agent\",\"process\",\"log\",\"message\",\"tags\",\"cloud\",\"input\",\"@timestamp\",\"data_stream\",\"host\",\"metrics\",\"metrics.size\",\"aws\",\"event\"],\"excludes\":[]},\"aggregations\":{\"composite_buckets\":{\"composite\":{\"size\":10000,\"sources\":[{\"metrics.size\":{\"terms\":{\"field\":\"metrics.size\",\"missing_bucket\":false,\"order\":\"asc\"}}}]},\"aggregations\":{\"$f1\":{\"top_hits\":{\"from\":0,\"size\":1,\"version\":false,\"seq_no_primary_term\":false,\"explain\":false,\"_source\":{\"includes\":[\"metrics.size\",\"agent\",\"process\",\"log\",\"message\",\"tags\",\"cloud\",\"input\",\"@timestamp\",\"data_stream\",\"host\",\"metrics\",\"aws\",\"event\"],\"excludes\":[]},\"script_fields\":{}}}}}}}, requestedTotalSize=2147483647, pageSize=null, startFrom=0)])\n"
  }
```


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite/big5/dedup_metrics_size_field.yaml:1`


> Looks like it now includes a PROJECT pushdown optimization

Did you run on the latest code? I didn't see the project pushdown action in the explain output.


## General Comments


### @LantaoJin


cc @aaarone90 
cc @ahkcs can you help to confirm the current fixing could address the issue of https://github.com/opensearch-project/sql/issues/4359 as long as the `CalcitePPLAggregationIT` passed?


---

# PR #4985: [AUTO] Increment version to 2.19.5-SNAPSHOT

**URL:** https://github.com/opensearch-project/sql/pull/4985

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-22T21:36:43Z

**State:** MERGED

**Merged:** 2026-01-07T16:34:53Z

**Changes:** +1 -1 (1 files)

**Labels:** `v2.19.5`


## Description

- Incremented version to **2.19.5-SNAPSHOT**.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


### @penghuo


Version bump, Ignore IT


---

# PR #4983: Support profile options for PPL - Part I Implement phases level metrics. 

**URL:** https://github.com/opensearch-project/sql/pull/4983

**Author:** @penghuo

**Created:** 2025-12-22T19:45:12Z

**State:** MERGED

**Merged:** 2026-01-09T02:31:35Z

**Changes:** +655 -11 (23 files)

**Labels:** `enhancement`, `PPL`, `backport-failed`, `backport 2.19-dev`

**Assignees:** @penghuo


## Description

### Description
- Introduce query profiling framework with profile contexts, metrics, and thread-local lifecycle helpers.
- Propagate PPL `profile` flag through transport and request parsing, enforce supported formats/paths, and document profiling usage.
- Capture per-phrase metrics across planning, optimization, execution, and response formatting; add profiling teardown and update related tests/expectations.
- Doc, https://github.com/penghuo/os-sql/blob/ee0d477cd56cdeddec6da15a334b82f606245ac5/docs/user/ppl/interfaces/endpoint.md#profile

### Related Issues
https://github.com/opensearch-project/sql/issues/4294

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @qianheng-aws - COMMENTED


@penghuo  Is this profile metric safe for parallelism updating? For `OPENSEARCH_TIME`,  it may be updated by multiple thread if there is join or union.


### @LantaoJin - CHANGES_REQUESTED


above


## Review Comments


### @penghuo on `integ-test/src/yamlRestTest/resources/rest-api-spec/test/api/ppl.profile.yml:None`


ignore it.


### @dai-chen on `docs/user/ppl/interfaces/endpoint.md:None`


Any future plan to include DSL profile output for each stage?


### @dai-chen on `core/src/main/java/org/opensearch/sql/monitor/profile/DefaultMetricImpl.java:43`


Is atomic operation required here?


### @dai-chen on `opensearch/src/main/java/org/opensearch/sql/opensearch/executor/OpenSearchExecutionEngine.java:205`


Just found this doesn't call listener properly which may cause profile context leak?


### @dai-chen on `core/src/main/java/org/opensearch/sql/executor/QueryService.java:150`


This is to avoid NPE somewhere?


### @penghuo on `opensearch/src/main/java/org/opensearch/sql/opensearch/executor/OpenSearchExecutionEngine.java:205`


Cleanup in [TransportPPLQueryAction](https://github.com/opensearch-project/sql/pull/4983/changes#diff-fd5cf7d596c746360ff54c37c1bd21bee320ee21ace49a03f1a5617b68150685R209)


### @penghuo on `docs/user/ppl/interfaces/endpoint.md:None`


No plan yet, Let me as experimental for profile option.


### @penghuo on `core/src/main/java/org/opensearch/sql/executor/QueryService.java:150`


yes, explain endpoint does not support profile.


### @penghuo on `core/src/main/java/org/opensearch/sql/monitor/profile/DefaultMetricImpl.java:43`


not necessary. Fix in https://github.com/opensearch-project/sql/pull/4983/changes/820d75783fcc9b1ab14f9366bd42dbc9b6929d9e


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/request/OpenSearchQueryRequest.java:None`


Should use `add` here since we support pagination for aggregate and this code will be called multiplet-times?


### @qianheng-aws on `core/src/main/java/org/opensearch/sql/monitor/profile/MetricName.java:9`


Do we need PARSE_TIME, though it should be tiny?


### @LantaoJin on `core/src/main/java/org/opensearch/sql/monitor/profile/DefaultMetricImpl.java:None`


Should be AtomicLong? We have multi-thread usage in opensearch_time


### @LantaoJin on `docs/user/ppl/interfaces/endpoint.md:None`


I'd like make all the metrics lower case which to align with OpenSearch DSL profile


### @LantaoJin on `core/src/main/java/org/opensearch/sql/monitor/profile/QueryProfiling.java:19`


We search with multiple threads on JOIN/Subsearch queries. We the total time should sum them.


### @penghuo on `core/src/main/java/org/opensearch/sql/monitor/profile/MetricName.java:9`


I ignore it for now, should be minial.


### @penghuo on `core/src/main/java/org/opensearch/sql/monitor/profile/DefaultMetricImpl.java:None`


Add back.


### @penghuo on `docs/user/ppl/interfaces/endpoint.md:None`


done.


### @penghuo on `core/src/main/java/org/opensearch/sql/monitor/profile/QueryProfiling.java:19`


see comments. https://github.com/opensearch-project/sql/pull/4983#issuecomment-3726499582


## General Comments


### @penghuo


> @penghuo Is this profile metric safe for parallelism updating? For `OPENSEARCH_TIME`, it may be updated by multiple thread if there is join or union.
> We search with multiple threads on JOIN/Subsearch queries. We the total time should sum them.

Agree. I sepereate into 2 PRs. 
The final output include Phases (current PR), and inlcude a Plan section to include operator level metrics PostgreSQL style (2nd PR).
```
"profile": {
  "summary": {
    "total_time_ms": 123.4
  },
  "phases": {
    "analyze":  { "time_ms": 4.8 },
    "optimize": { "time_ms": 8.3 },
    "execute":  { "time_ms": 95.0 },
    "format":   { "time_ms": 14.1 }
  },
  "plan": {
    "node": "Result",
    "time_ms": 14.0,
    "rows": 1000,
    "children": [
      {
        "node": "HashJoin",
        "time_ms": 60.0,
        "rows": 1000,
        "children": [
          { "node": "Scan(index_a)", "time_ms": 30.0},
          { "node": "Scan(index_b)", "time_ms": 28.0}
        ]
      }
    ]
  }
}
```



---

# PR #4981: Remove GetAlias Call

**URL:** https://github.com/opensearch-project/sql/pull/4981

**Author:** @aparajita31pandey

**Created:** 2025-12-22T04:37:12Z

**State:** MERGED

**Merged:** 2026-01-09T17:44:55Z

**Changes:** +43 -9 (2 files)

**Labels:** `backport 2.19-dev`, `bugFix`


## Description

### Description
This diff is removes a redundant alias-resolution call via the `GET /_alias/<alias>` API  that requires the caller to have extra indices:admin/aliases/get privileges, which can cause permission issues when executing read queries.

It instead leverages existing  `GetFieldMapping` call that works for both index and alias.

Tested Functionality
#### With Index Name
```
curl -X POST "localhost:9200/_plugins/_sql"  -H 'Content-Type: application/json' \
  -d '{
    "query": "SELECT * FROM my-index",
    "fetch_size": 1,
    "filter": {
      "term": {
        "another_field": "hello"
      }
    }
  }'
Output - 
{
  "schema": [
    {
      "name": "new_field",
      "type": "text"
    },
    {
      "name": "another_field",
      "type": "keyword"
    }
  ],
  "total": 1,
  "datarows": [[
    "Some text",
    "hello"
  ]],
  "size": 1,
  "status": 200
}
```

#### With Alias Name - Same Output
```
curl -X POST "localhost:9200/_plugins/_sql"   -H 'Content-Type: application/json' \
  -d '{
    "query": "SELECT * FROM my-alias",
    "fetch_size": 1,
    "filter": {
      "term": {
        "another_field": "hello"
      }
    }
  }'
Output - 
{
  "schema": [
    {
      "name": "new_field",
      "type": "text"
    },
    {
      "name": "another_field",
      "type": "keyword"
    }
  ],
  "total": 1,
  "datarows": [[
    "Some text",
    "hello"
  ]],
  "size": 1,
  "status": 200
}
```
### Related Issues
Resolves 
#2960, https://github.com/opensearch-project/security/issues/5871

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @Swiddis - DISMISSED


Ideally this should have an integ test, but nothing wrong with the impl


### @aalva500-prog - APPROVED


LGTM, but agree with @Swiddis that some test would be ideal.


### @dai-chen - APPROVED


Thanks for the fix!


## Review Comments


### @dai-chen on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/SelectResultSet.java:None`


Could you double check if multiple entires can be returned in certain case? Just want to make sure this check is not too strict and fail in valid case.

```
# Create test-index-1, 2, 3
curl -X PUT "localhost:9200/test-index-1" -H 'Content-Type: application/json' -d'
{
  "mappings": {
    "properties": {
      "name": { "type": "text" },
      "age": { "type": "integer" },
      "timestamp": { "type": "date" }
    }
  }
}'

...

curl -X POST "localhost:9200/_aliases" -H 'Content-Type: application/json' -d'
{
  "actions": [
    { "add": { "index": "test-index-*", "alias": "wildcard-alias" } }
  ]
}'

curl -X GET "localhost:9200/wildcard-alias/_mapping?pretty"
{
  "test-index-1" : {
    ...
  },
  "test-index-2" : {
    ...
  },
  "test-index-3" : {
    ...
}
```


### @aalva500-prog on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/SelectResultSet.java:None`


Hi @aparajita31pandey, could you take a look at this? thanks!


### @aparajita31pandey on `legacy/src/main/java/org/opensearch/sql/legacy/executor/format/SelectResultSet.java:None`


@dai-chen Thankyou for pointing this out. I have updated the code and have added similar `integ-test` around it. Please have a look.


## General Comments


### @aparajita31pandey


@LantaoJin Can I please get a review ?


### @Swiddis


Re: integ tests, I have https://github.com/opensearch-project/sql/pull/5008 which lays a lot more groundwork for adding more permissions-related tests to our codebase.

Since this PR was opened before that existed, I won't block on it -- after both PRs merge I'll write a small task for myself to add a test for this.


### @aparajita31pandey


@Swiddis @aalva500-prog I have added a small integ test for this change. Can I get a re-review ?


---

# PR #4979: Support nested aggregation when calcite enabled

**URL:** https://github.com/opensearch-project/sql/pull/4979

**Author:** @LantaoJin

**Created:** 2025-12-19T09:59:29Z

**State:** MERGED

**Merged:** 2026-01-05T02:46:24Z

**Changes:** +1181 -215 (43 files)

**Labels:** `enhancement`, `backport-manually`, `backport-failed`, `backport 2.19-dev`


## Description

### Description
Refactor implementation for PPL: https://github.com/opensearch-project/sql/pull/3696 (closed)
Deprecated implementation for SQL: https://github.com/opensearch-project/sql/pull/2814 (closed)

Support [nested aggregation](https://docs.opensearch.org/docs/latest/aggregations/bucket/nested/) in PPL only when calcite enabled.

With this PR, follow PPL query is able to execute a nested aggregation query.
```SQL
source=logs | head 10000 | stats min(pages.load_time)
```
And it equals the DSL
```
GET logs/_search
{
  "aggs": {
    "pages": {
      "nested": {
        "path": "pages"
      },
      "aggs": {
        "min_load_time": { "min": { "field": "pages.load_time" } }
      }
    }
  }
}
```

Follow queries (group-by nested path) are supported with this PR as well:
```
source=test | top pages.load_time
source=test | stats count() by pages.load_time
source=test | dedup pages.load_time
```

**Limitation:**
- PPL only
- Calcite should be enabled
- Throw **UnsupportedOperationException** if pushdown cannot be applied.
- Follow queries (group-by nested root path) are supported with this PR without pushdown enahncement:
```
source=test | top pages
source=test | stats count() by pages
source=test | dedup pages
```

### Related Issues
Resolves https://github.com/opensearch-project/sql/issues/4949, https://github.com/opensearch-project/sql/issues/4564, https://github.com/opensearch-project/sql/issues/2813 and https://github.com/opensearch-project/sql/issues/2529, and https://github.com/opensearch-project/sql/issues/2739

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @LantaoJin on `core/src/main/java/org/opensearch/sql/calcite/utils/CalciteToolsHelper.java:179`


After upgraded to 1.41. this method was not called any more, change it to `createPrepare()`


### @LantaoJin on `core/src/main/java/org/opensearch/sql/calcite/utils/CalciteToolsHelper.java:301`


This hook was called twice for non-full-scannable plan


### @LantaoJin on `core/src/main/java/org/opensearch/sql/calcite/utils/PPLHintStrategyTable.java:None`


rename `stats_args` to `agg_args` since aggregation was not only happens in `stats` command.


### @LantaoJin on `docs/user/ppl/interfaces/endpoint.md:114`


avoid whole-plan-pushdown


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/response/error/ErrorMessageFactory.java:39`


For some exception without cause (root exception), the actual root cause may be attached in its suppressed cause.


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/response/error/ErrorMessageFactory.java:28`


Prefer to display the root cause instead of wrapping exception.


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/request/AggregateAnalyzer.java:241`


To avoid ambiguous, we call the multiple sub-aggregations `structured` aggregations instead of `nested`


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/request/AggregateAnalyzer.java:367`


Here the value could be `min(a.b), count(c)`, rename `aggFieldNames` to `aggNames`. 


## General Comments


_No general comments from humans_


---

# PR #4978: [Backport 2.19-dev] Support pushdown dedup with expression (#4957)

**URL:** https://github.com/opensearch-project/sql/pull/4978

**Author:** @LantaoJin

**Created:** 2025-12-19T07:03:33Z

**State:** MERGED

**Merged:** 2025-12-22T02:17:24Z

**Changes:** +645 -170 (39 files)


## Description

(cherry picked from #4957 commit cbcdbd6fc918e4a356480300c208aa76f468fbf1)



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4976: Add Frequently Used Big5 PPL Queries

**URL:** https://github.com/opensearch-project/sql/pull/4976

**Author:** @aalva500-prog

**Created:** 2025-12-18T22:30:01Z

**State:** MERGED

**Merged:** 2026-01-06T18:58:48Z

**Changes:** +157 -2 (7 files)

**Labels:** `testing`, `backport 2.19-dev`


## Description

### Description
This PR continues the work done in PR #4816 to add frequent used queries to the big5 workload based on gap analysis between existing benchmarks and frequent used query patterns.

`dedup` query is added here: #4991

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @LantaoJin - COMMENTED


can you resolve the conflicts


## Review Comments


### @anasalkouz on `integ-test/src/test/resources/big5/queries/rex_regex_transformation.ppl:25`


nit: maybe explain what this query do


### @dai-chen on `integ-test/src/test/java/org/opensearch/sql/calcite/big5/CalcitePPLBig5IT.java:None`


Any reason to do correctness check for this one? I thought this IT is only for benchmark?


### @dai-chen on `integ-test/src/test/java/org/opensearch/sql/calcite/remote/CalcitePPLAggregationIT.java:741`


This PR is only to add more test queries right? Why the behavior changed?


### @aalva500-prog on `integ-test/src/test/java/org/opensearch/sql/calcite/remote/CalcitePPLAggregationIT.java:741`


The behavior changed because the file `integ-test/src/test/resources/big5/data/big5.json` was modified and now has more data.


### @aalva500-prog on `integ-test/src/test/java/org/opensearch/sql/calcite/big5/CalcitePPLBig5IT.java:None`


This PR is to continue the work done here by @noCharger: https://github.com/opensearch-project/sql/pull/4816. I don't have the whole context, unfortunately. However, I think it is not only for benchmark, as the same was done for the`dedup` command in this PR: https://github.com/opensearch-project/sql/pull/4991


### @dai-chen on `integ-test/src/test/java/org/opensearch/sql/calcite/big5/CalcitePPLBig5IT.java:None`


But other test methods (except dedup) only do timing without this assertion? My understanding is this IT shouldn't do correctness check.


### @aalva500-prog on `integ-test/src/test/java/org/opensearch/sql/calcite/big5/CalcitePPLBig5IT.java:None`


Removed correctness check for rex command.


## General Comments


### @aalva500-prog


@Swiddis the SQL CLI Integration tests are failing, any recommendations on how to fix this?


---

# PR #4974: Add unified query compiler API

**URL:** https://github.com/opensearch-project/sql/pull/4974

**Author:** @dai-chen

**Created:** 2025-12-18T17:59:34Z

**State:** MERGED

**Merged:** 2026-01-07T18:01:02Z

**Changes:** +554 -42 (10 files)

**Labels:** `enhancement`, `backport 2.19-dev`

**Assignees:** @dai-chen


## Description

### Description

This PR introduces a `UnifiedQueryCompiler` as part of the Unified Execution Runtime, enabling direct evaluation of PPL queries via a reference implementation. It completes the third pillar of the Unified Query API (alongside unified query planner and transpiler) and allows external consumers to execute PPL end-to-end using a Calcite-based in-memory evaluator, as described in #4782.

**Key Changes**

- `UnifiedQueryCompiler`: Introduces a new API that compiles Calcite logical plans into executable JDBC statements.
- `UnifiedQueryContext` lifecycle management: Implements AutoCloseable to properly manage resource lifecycle.
- Integration tests: Adds end-to-end integration tests demonstrating the complete workflow from context creation, query planning, compilation, and execution.

### Related Issues
Resolves https://github.com/opensearch-project/sql/issues/4894

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @penghuo on `api/README.md:121`


UnifiedQueryCompiler.compile() compiles a RelNode into an executable query plan by leveraging Calcite’s Enumerable physical operators?


### @dai-chen on `api/README.md:121`


Yes, it's the same as current PPL Calcite logic in core module. Thanks!


## General Comments


_No general comments from humans_


---

# PR #4971: [Backport 2.19-dev] Add scalar min/max to BuiltinFunctionName (#4967)

**URL:** https://github.com/opensearch-project/sql/pull/4971

**Author:** @LantaoJin

**Created:** 2025-12-18T02:13:17Z

**State:** MERGED

**Merged:** 2025-12-18T06:52:23Z

**Changes:** +14 -7 (4 files)


## Description

(cherry picked from #4967 commit 7dfabcea94952ead0a27463d810097d74446acc4)



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4970: [Backport 2.19-dev] Extract unified query context for shared config management

**URL:** https://github.com/opensearch-project/sql/pull/4970

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-17T22:54:42Z

**State:** MERGED

**Merged:** 2025-12-18T02:14:00Z

**Changes:** +343 -215 (7 files)


## Description

Backport 297074c1ed595c9d2e6ec34b6cca8ad6a247d0ea from #4933.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4967: Add scalar min/max to BuiltinFunctionName

**URL:** https://github.com/opensearch-project/sql/pull/4967

**Author:** @LantaoJin

**Created:** 2025-12-17T05:59:15Z

**State:** MERGED

**Merged:** 2025-12-18T02:09:50Z

**Changes:** +14 -7 (4 files)

**Labels:** `enhancement`, `backport-manually`, `backport-failed`, `backport 2.19-dev`


## Description

### Description
Add scalar min/max to BuiltinFunctionName.

Since parsing min/max aggregation function and scalar function (eval function) in AST parser are separated, we can use different names in `BuiltinFunctionName` with no changes in PPL interface/syntax.

`eval a = max(b)` -> SCALAR_MAX
`stats max(b)/eventstats max(b)/streamstats max(b)` -> (AGG) MAX

### Related Issues
Resolves #4774 

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @dai-chen - APPROVED


Thanks for the fix!


## Review Comments


### @yuancu on `core/src/main/java/org/opensearch/sql/calcite/CalciteRelNodeVisitor.java:2908`


Can you please kindly add a javadoc on `BuiltinFunctionName.of` to instruct future developers to use `BuiltinFunctionName.ofAggregation` for aggregation functions?


## General Comments


_No general comments from humans_


---

# PR #4965: [Backport 2.19-dev] Support `mvmap` eval function

**URL:** https://github.com/opensearch-project/sql/pull/4965

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-16T22:21:56Z

**State:** MERGED

**Merged:** 2025-12-17T02:34:10Z

**Changes:** +499 -11 (15 files)


## Description

Backport 11727a488a77ae392ef0f9da4bbde601937ffc5f from #4856.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4964: [Backport 2.19-dev] Feature addtotals and addcoltotals

**URL:** https://github.com/opensearch-project/sql/pull/4964

**Author:** @dai-chen

**Created:** 2025-12-16T22:12:48Z

**State:** MERGED

**Merged:** 2025-12-17T00:26:46Z

**Changes:** +2313 -1 (25 files)

**Assignees:** @dai-chen


## Description

Backport 15e2411aba434f39d9b0c0d57e0f9b2e1b6f4c87 from #4754 with integration test fix by enabling Calcite.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4963: [Backport 2.19-dev] issue #4514 tonumber function as part of roadmap #4287

**URL:** https://github.com/opensearch-project/sql/pull/4963

**Author:** @dai-chen

**Created:** 2025-12-16T19:28:01Z

**State:** MERGED

**Merged:** 2025-12-17T00:26:13Z

**Changes:** +688 -2 (11 files)

**Assignees:** @dai-chen


## Description

Backport 342a78be6b83fb36df839cc840bb90b687a4751e from #4605 with additional integration test fix by enabling Calcite.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4962: Update CodeRabbit instructions

**URL:** https://github.com/opensearch-project/sql/pull/4962

**Author:** @ykmr1224

**Created:** 2025-12-15T21:27:08Z

**State:** MERGED

**Merged:** 2025-12-17T23:04:44Z

**Changes:** +95 -4 (1 files)

**Labels:** `infrastructure`


## Description

### Description
- Update CodeRabbit instructions based on #4497, #4605, #4675

### Related Issues
- https://github.com/opensearch-project/sql/issues/4889

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @dai-chen - APPROVED


Thanks for the changes!


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4961: [Backport 2.19-dev] Support `mvzip` eval function

**URL:** https://github.com/opensearch-project/sql/pull/4961

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-15T21:08:05Z

**State:** MERGED

**Merged:** 2025-12-16T20:39:56Z

**Changes:** +457 -1 (10 files)


## Description

Backport 52a691a7e63c03f7acf7b1df0f118a3952257f95 from #4805.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4958: Escape underscore character in documentation for LIKE

**URL:** https://github.com/opensearch-project/sql/pull/4958

**Author:** @Blitheness

**Created:** 2025-12-15T14:06:24Z

**State:** MERGED

**Merged:** 2025-12-15T21:21:44Z

**Changes:** +3 -3 (1 files)

**Labels:** `documentation`, `PPL`


## Description

### Description
Properly escape underscore character in documentation for LIKE so it doesn't render as italicised text.

### Related Issues
NA

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @penghuo - APPROVED


Thanks!


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4957: Support pushdown dedup with expression

**URL:** https://github.com/opensearch-project/sql/pull/4957

**Author:** @LantaoJin

**Created:** 2025-12-15T10:18:02Z

**State:** MERGED

**Merged:** 2025-12-19T06:41:38Z

**Changes:** +655 -170 (39 files)

**Labels:** `enhancement`, `backport-manually`, `backport-failed`, `backport 2.19-dev`


## Description

### Description
Support pushdown `dedup` with expression:
- the dedup columns contain expressions
  - `| eval new_gender = lower(gender), new_name = lower(name) | dedup 2 new_gender, new_name`
- the other columns contain expressions
  - `| eval new_gender = lower(gender), new_name = lower(name) | dedup 2 gender, name`
 
This PR also implicitly support pushdown `join with max option` with expressions
- the join keys contain expressions
  - `source = t1 | eval new_gender = lower(gender) | join new_gender [source = t2 | eval new_gender = lower(gender) ]`
- the other columns contain expresssions
  - `source = t1 | eval new_gender = lower(gender) | join gender [source = t2 | eval new_gender = lower(gender) ]`

### Related Issues
Resolves #4789 

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @yuancu on `opensearch/src/main/java/org/opensearch/sql/opensearch/response/agg/TopHitsParser.java:None`


nit: use `var` or `Map<String, Object>`


### @yuancu on `opensearch/src/main/java/org/opensearch/sql/opensearch/response/agg/TopHitsParser.java:91`


Seems the comment also needs updated, as it no longer returns source but fields


### @yuancu on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:118`


Can you explain the intuition / reason for reordering the columns?


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:118`


That's why I suggested you to use aggregateWithTrimming() instead of calling the relBuilder.aggregate() directly. In SQL, the Project added for Aggregate always keeps the group columns in the front of others, it means the group keys set always contain {0}, or there could be trigger a Calcite bug.


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/response/agg/TopHitsParser.java:91`


It still returns source, the field will be added when scripts are existed.


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:94`


Seems this be simplified to 
```
  dedupColumnIndices.stream()
     .map(projectWithWindow.getInput().getRowType().getFieldNames()::get)
     .toList()
```




### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:96`


Will this ever happened since dedupColumnNames is derived from dedupColumnIndices?


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:118`


I don't get it as well. Since the `aggregate` is going to be pushed into scan and the final generated RelNode is a single `Scan` operator, will it really trigger the bug in Calcite? 

Do we do similar thing in the previous PR for supporting dedup push down?


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/request/AggregateAnalyzer.java:None`


There is already `import org.apache.commons.lang3.tuple.Pair` imported. Could it be switched to that or at least unified?


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/request/AggregateAnalyzer.java:None`


sure. will convert to common.lang3's Pair


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/response/agg/TopHitsParser.java:None`


The definition is in L93 `.<Map<String, Object>>map(`. But yes, I can add `Map<String, Object>` here and remove L93. The reason use L93 instead of `Map<String, Object>` is we used unnamed variable, but now it has to define a name.


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:94`


No. above code doesn't cover the rename case:
```
source=test | rename status as http_status | dedup http_status | fields http_status | sort http_status
```


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:96`


I am 100% sure they have same size. Better to keep this check.


### @LantaoJin on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:118`


> I don't get it as well. Since the `aggregate` is going to be pushed into scan and the final generated RelNode is a single `Scan` operator, will it really trigger the bug in Calcite?
> 
> Do we do similar thing in the previous PR for supporting dedup push down?

Yes. I see bugs when the group key columns are not in the front of child Project in Calcite in developing support Aggregate with Calcite. Not sure is it fixed or not. Check the comment here https://github.com/opensearch-project/sql/blob/7dfabcea94952ead0a27463d810097d74446acc4/core/src/main/java/org/opensearch/sql/calcite/CalciteRelNodeVisitor.java#L1049


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/planner/rules/DedupPushdownRule.java:118`


That happens in CalciteRelNodeVisitor, but is similar change needed in the push down process?



## General Comments


_No general comments from humans_


---

# PR #4956: [Backport 2.19-dev] Pushdown join with `max=n` option to TopHits aggregation (#4929)

**URL:** https://github.com/opensearch-project/sql/pull/4956

**Author:** @LantaoJin

**Created:** 2025-12-12T07:24:55Z

**State:** MERGED

**Merged:** 2025-12-12T08:15:42Z

**Changes:** +168 -130 (27 files)


## Description

(cherry picked from #4929 commit 4bf5c9c776e7f8cb11714d68fbc2c9163475ef23)



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4955: remove shadow jar

**URL:** https://github.com/opensearch-project/sql/pull/4955

**Author:** @xinyual

**Created:** 2025-12-12T06:18:09Z

**State:** MERGED

**Merged:** 2025-12-15T02:17:54Z

**Changes:** +2 -69 (2 files)

**Labels:** `dependencies`, `maintenance`


## Description

### Description
We try to remove shadow jar since access control now is already removed in core.
Revert the change in PR https://github.com/opensearch-project/sql/pull/3447

Also fix an IT due to the import name changed from 
shaded.com.google -> com.google

### Related Issues
Resolves #[Issue number to be closed when this PR is merged]
<!-- List any other related issues here -->

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/ppl/explain_patterns_simple_pattern_agg_push.yaml:12`


It confused me why a plan changed by your PR


### @xinyual on `integ-test/src/test/resources/expectedOutput/ppl/explain_patterns_simple_pattern_agg_push.yaml:12`


After decode, the script previously using 
`import shaded.com.google...` 
The `shaded` here is caused by shade jar.
But now we remove it, so it is 
`import com.google...`
So the script changed.


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/ppl/explain_patterns_simple_pattern_agg_push.yaml:12`


can you run explain command with `extended` and attach the result here


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/ppl/explain_patterns_simple_pattern_agg_push.yaml:12`


oh, it's a v2 plan. not sure how to decode the base64 string.


### @xinyual on `integ-test/src/test/resources/expectedOutput/ppl/explain_patterns_simple_pattern_agg_push.yaml:12`


Using online decode and here are the result:
using shadow jar

�^Esr�6org.opensearch.sql.expression.parse.PatternsExpressionΪG^F^B�^BZ�^PuseCustomPatternL�^Gpatternt�^YLjava/util/regex/Pattern;xr�3org.opensearch.sql.expression.parse.ParseExpression
}^B�^DL�
identifiert�*Lorg/opensearch/sql/expression/Expression;L�
identifierStrt�^RLjava/lang/String;L�^Gpatternq�~�^CL�sourceFieldq�~�^Cxr�0org.opensearch.sql.expression.FunctionExpression*0uj{^B�^BL�	argumentst�^PLjava/util/List;L�functionNamet�5Lorg/opensearch/sql/expression/function/FunctionName;xpsr�=`shaded.com.google.common.collect.ImmutableList$SerializedForm`��������^B�^A[�elementst�^S[Ljava/lang/Object;xpur�^S[Ljava.lang.Object;X^Ps)l^B��xp���^Csr�1org.opensearch.sql.expression.ReferenceExpressionD\^R^G^B�^DL�^Dattrq�~�^DL�^Epathsq�~�^FL�^GrawPathq�~�^DL�^Dtypet�'Lorg/opensearch/sql/data/type/ExprType;xpt�^Eemailsr�^Zjava.util.Arrays$ArrayList٤<͈^F^B�^A[�^Aaq�~�
xpur�^S[Ljava.lang.String;V^]{G^B��xp���^Aq�~�^Qq�~�^Qsr�:org.opensearch.sql.opensearch.data.type.OpenSearchTextType^D1D^B�^AL�^Ffieldst�^OLjava/util/Map;xr�:org.opensearch.sql.opensearch.data.type.OpenSearchDataTypec^B^E5^B�^CL�exprCoreTypet�+Lorg/opensearch/sql/data/type/ExprCoreType;L�mappingTypet�HLorg/opensearch/sql/opensearch/data/type/OpenSearchDataType$MappingType;L�
propertiesq�~�^Wxp~r�)org.opensearch.sql.data.type.ExprCoreType��������^R��xr�^Njava.lang.Enum��������^R��xpt�^GUNKNOWN~r�Forg.opensearch.sql.opensearch.data.type.OpenSearchDataType$MappingType��������^R��xq�~�^]t�^DTextsr�<*`shaded.com.google.common.collect.ImmutableMap$SerializedForm`*��������^B�^BL�^Dkeyst�^RLjava/lang/Object;L�^Fvaluesq�~�$xpuq�~�����uq�~�����sr�^Qjava.util.CollSerW:^[^Q^C�^AI�^Ctagxp���^Cw^D���^Bt�^Gkeywordsq�~�^X~q�~�^\t�^FSTRING~q�~� t�^GKeywordq�~�%xsr�/org.opensearch.sql.expression.LiteralExpressionEB-ǂ$^B�^AL�	exprValuet�)Lorg/opensearch/sql/data/model/ExprValue;xpsr�-org.opensearch.sql.data.model.ExprStringValue�A2%s^N^S^B�^AL�^Evalueq�~�^Dxr�/org.opensearch.sql.data.model.AbstractExprValuekv^F^TD^B��xpt��sq�~�0sq�~�3t�^Npatterns_fieldsr�3org.opensearch.sql.expression.function.FunctionName8Mg^B�^AL�functionNameq�~�^Dxpt�patternsq�~�7q�~�9q�~�2q�~�^P�p


And without shadow jar

�^Esr�6org.opensearch.sql.expression.parse.PatternsExpressionΪG^F^B�^BZ�^PuseCustomPatternL�^Gpatternt�^YLjava/util/regex/Pattern;xr�3org.opensearch.sql.expression.parse.ParseExpression}^B�^DL�
identifiert�*Lorg/opensearch/sql/expression/Expression;L�
identifierStrt�^RLjava/lang/String;L�^Gpatternq�~�^CL�sourceFieldq�~�^Cxr�0org.opensearch.sql.expression.FunctionExpression*0uj{^B�^BL�	argumentst�^PLjava/util/List;L�functionNamet�5Lorg/opensearch/sql/expression/function/FunctionName;xpsr�6*`com.google.common.collect.ImmutableList$SerializedForm`*��������^B�^A[�elementst�^S[Ljava/lang/Object;xpur�^S[Ljava.lang.Object;X^Ps)l^B��xp���^Csr�1org.opensearch.sql.expression.ReferenceExpressionD\^R^G^B�^DL�^Dattrq�~�^DL�^Epathsq�~�^FL�^GrawPathq�~�^DL�^Dtypet�'Lorg/opensearch/sql/data/type/ExprType;xpt�^Eemailsr�^Zjava.util.Arrays$ArrayList٤<͈^F^B�^A[�^Aaq�~�
xpur�^S[Ljava.lang.String;V^]{G^B��xp���^Aq�~�^Qq�~�^Qsr�:org.opensearch.sql.opensearch.data.type.OpenSearchTextType^D1D^B�^AL�^Ffieldst�^OLjava/util/Map;xr�:org.opensearch.sql.opensearch.data.type.OpenSearchDataTypec^B^E5^B�^CL�exprCoreTypet�+Lorg/opensearch/sql/data/type/ExprCoreType;L�mappingTypet�HLorg/opensearch/sql/opensearch/data/type/OpenSearchDataType$MappingType;L�
propertiesq�~�^Wxp~r�)org.opensearch.sql.data.type.ExprCoreType��������^R��xr�^Njava.lang.Enum��������^R��xpt�^GUNKNOWN~r�Forg.opensearch.sql.opensearch.data.type.OpenSearchDataType$MappingType��������^R��xq�~�^]t�^DTextsr�5*`com.google.common.collect.ImmutableMap$SerializedForm`*��������^B�^BL�^Dkeyst�^RLjava/lang/Object;L�^Fvaluesq�~�$xpuq�~�����uq�~�����sr�^Qjava.util.CollSerW:^[^Q^C�^AI�^Ctagxp���^Cw^D���^Bt�^Gkeywordsq�~�^X~q�~�^\t�^FSTRING~q�~� t�^GKeywordq�~�%xsr�/org.opensearch.sql.expression.LiteralExpressionEB-ǂ$^B�^AL�	exprValuet�)Lorg/opensearch/sql/data/model/ExprValue;xpsr�-org.opensearch.sql.data.model.ExprStringValue�A2%s^N^S^B�^AL�^Evalueq�~�^Dxr�/org.opensearch.sql.data.model.AbstractExprValuekv^F^TD^B��xpt��sq�~�0sq�~�3t�^Npatterns_fieldsr�3org.opensearch.sql.expression.function.FunctionName8Mg^B�^AL�functionNameq�~�^Dxpt�patternsq�~�7q�~�9q�~�2q�~�^P�p

You could see the com.google.common.collect.ImmutableList$SerializedForm path changed.


## General Comments


_No general comments from humans_


---

# PR #4954: [Backport 2.19-dev] [DOC] Show backticks in testing-doctest.md

**URL:** https://github.com/opensearch-project/sql/pull/4954

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-12T03:56:22Z

**State:** MERGED

**Merged:** 2025-12-12T05:55:56Z

**Changes:** +6 -6 (1 files)


## Description

Backport c527afc0f0e7868068b69a05c521cf1ee7c70334 from #4941.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4953: [Backport 2.19-dev] [DOC] Callout the aggregation result may be approximate

**URL:** https://github.com/opensearch-project/sql/pull/4953

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-12T03:55:44Z

**State:** MERGED

**Merged:** 2025-12-12T05:55:49Z

**Changes:** +58 -1 (3 files)


## Description

Backport 90ee47c6f909d38f5ba12cef3c2bda8c5f23cce5 from #4922.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4951: [Backport 2.19-dev] RexCall and RelDataType standardization for script push down (#4914)

**URL:** https://github.com/opensearch-project/sql/pull/4951

**Author:** @qianheng-aws

**Created:** 2025-12-12T03:05:00Z

**State:** MERGED

**Merged:** 2025-12-12T05:56:18Z

**Changes:** +303 -79 (43 files)


## Description

Backport https://github.com/opensearch-project/sql/commit/bcfcd002d5ec402f257a92f9689097d1c9bf8979 from https://github.com/opensearch-project/sql/pull/4914.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4950: [DOC] PPL docs website exporter script

**URL:** https://github.com/opensearch-project/sql/pull/4950

**Author:** @kylehounslow

**Created:** 2025-12-12T01:25:36Z

**State:** MERGED

**Merged:** 2025-12-15T21:30:17Z

**Changes:** +273 -76 (7 files)

**Labels:** `infrastructure`


## Description

### Description
Add an automated exporter script that transforms PPL markdown documentation tree (`docs/user/ppl/**/*.md`) into Jekyll-compatible format for the OpenSearch documentation website.

#### Summary of changes  
* Add PPL docs exporter script  
* Minor nit fixes to existing markdown docs (discovered when rendering local build of docs website)

#### Demo 
Screen recording of rendered Jekyll site after exporting PPL docs. No manual changes applied. **See the files exported to documentation-website for below demo [here](https://github.com/kylehounslow/documentation-website/tree/381a7a0d733cd43bfc98d6cef748775a09ecc10e/_sql-and-ppl/ppl-reference)**

https://github.com/user-attachments/assets/07fdf522-5b42-4b1f-a993-ab8dd7798f6c




#### Exporter script features
- **Jekyll front-matter generation**: Auto-injects layout, title, parent/grand_parent hierarchy, and navigation order
- **link resolution**: Handles all relative link patterns (../, ./, same-directory, subdirectory)
- **Jekyll anchor normalization**: Converts anchors to match Jekyll's format (removes dots/dashes)
- **Deep directory rollup**: Flattens 3+ level directories with automatic redirect_from for original paths. **This is a workaround for a limitation in `just-the-docs` theme on docs website**.
- **Content transformations**: 
  - Converts PPL code fences to SQL syntax highlighting
  - Adds copy buttons to code blocks
- **Directory heading mappings**: Consistent navigation titles (e.g., cmd → "Commands")

### Related Issues
* https://github.com/opensearch-project/sql/issues/4854
* https://github.com/opensearch-project/sql/pull/4912

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @Swiddis - APPROVED


lgtm, could probably find maintainability nits if I tried but since this is a one-off script we probably don't need to worry about it


## Review Comments


### @kylehounslow on `scripts/docs_exporter/export_to_docs_website.py:146`


This is incorrect. Without global .md replacement, it would miss anchor links (headings). Example from [ppl/cmd/grok.md](https://github.com/opensearch-project/sql/blob/4bf5c9c776e7f8cb11714d68fbc2c9163475ef23/docs/user/ppl/cmd/grok.md?plain=1#L86): 

````
## Limitations  
The grok command has the same limitations as the parse command, see [parse limitations](./parse.md#Limitations) for details.
````


### @Swiddis on `scripts/docs_exporter/export_to_docs_website.py:301`


non-portable paths, but if i understand right this only runs in CI servers or in a box where we control the platform


### @penghuo on `docs/user/ppl/index.md:14`


when should add ppl ignore?


### @kylehounslow on `docs/user/ppl/index.md:14`


The `ignore` keyword will [omit the code block from doctests](https://github.com/opensearch-project/sql/blob/ccdb0f77454fa2fcba33540b87e934ec89a25b67/doctest/markdown_parser.py#L139-L140). For this case, we want to exclude from doctests but still want `ppl` syntax highlighting applied. 
Note: All `ppl` blocks are [converted to `sql` formatting](https://github.com/kylehounslow/sql/blob/3354c91512f0369b58bf80ffb72e084870308394/scripts/docs_exporter/export_to_docs_website.py#L151) on export to docs website (`sql` is the closest format supported for syntax highlighting). 


### @kylehounslow on `scripts/docs_exporter/export_to_docs_website.py:301`


Uses `pathlib.Path` object with `/` operator ([src](https://github.com/python/cpython/blob/27a2e49d1849751008ea5807558129e11d35fb7a/Lib/pathlib/__init__.py#L176)). Should be portable to all OS


### @Swiddis on `scripts/docs_exporter/export_to_docs_website.py:301`


Ah, I didn't realize the slash operator carrried to the tailing strings. I thought we'd end up with `{script_dir}\../...`. TIL


## General Comments


### @kylehounslow


@coderabbitai review


---

# PR #4946: [Backport 3.4] Update 3.4 release note

**URL:** https://github.com/opensearch-project/sql/pull/4946

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-11T17:33:13Z

**State:** MERGED

**Merged:** 2025-12-11T17:55:49Z

**Changes:** +8 -8 (1 files)


## Description

Backport fc3a9355a84d33db2d30be72c7a2b000de7787f8 from #4939.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4945: [Backport main] Update 3.4 release note

**URL:** https://github.com/opensearch-project/sql/pull/4945

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-11T17:33:01Z

**State:** MERGED

**Merged:** 2025-12-11T17:55:45Z

**Changes:** +8 -8 (1 files)


## Description

Backport fc3a9355a84d33db2d30be72c7a2b000de7787f8 from #4939.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4942: [Backport 2.19-dev] Replace duplicated aggregation logic with `aggregateWithTrimming()`

**URL:** https://github.com/opensearch-project/sql/pull/4942

**Author:** @ishaoxy

**Created:** 2025-12-11T07:56:50Z

**State:** MERGED

**Merged:** 2025-12-11T08:28:44Z

**Changes:** +65 -82 (10 files)


## Description

### Description
backport #4926 

### Related Issues
Resolves #[Issue number to be closed when this PR is merged]
<!-- List any other related issues here -->

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4941: [DOC] Show backticks in testing-doctest.md

**URL:** https://github.com/opensearch-project/sql/pull/4941

**Author:** @LantaoJin

**Created:** 2025-12-11T05:15:36Z

**State:** MERGED

**Merged:** 2025-12-11T08:32:03Z

**Changes:** +6 -6 (1 files)

**Labels:** `documentation`, `backport 2.19-dev`


## Description

### Description
Show backticks in testing-doctest.md

Before:
<img width="733" height="123" alt="Screenshot 2025-12-11 at 1 14 09 PM" src="https://github.com/user-attachments/assets/418c25cf-89ba-492b-ad3f-a4c97cd1e6f5" />

After:
<img width="652" height="126" alt="Screenshot 2025-12-11 at 1 14 56 PM" src="https://github.com/user-attachments/assets/a40f10a8-3d7a-427c-91b8-d8a9a108a798" />


### Related Issues
Resolves #[Issue number to be closed when this PR is merged]
<!-- List any other related issues here -->

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


### @LantaoJin


ping @kylehounslow 


---

# PR #4939: Update 3.4 release note

**URL:** https://github.com/opensearch-project/sql/pull/4939

**Author:** @ahkcs

**Created:** 2025-12-10T23:31:09Z

**State:** MERGED

**Merged:** 2025-12-11T02:26:09Z

**Changes:** +8 -8 (1 files)

**Labels:** `backport main`, `backport 3.4`


## Description

### Description
3.4 release note update



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4938: [Backport 2.19-dev] backport markdown doctest support

**URL:** https://github.com/opensearch-project/sql/pull/4938

**Author:** @kylehounslow

**Created:** 2025-12-10T23:12:37Z

**State:** MERGED

**Merged:** 2025-12-11T18:44:20Z

**Changes:** +19030 -17651 (150 files)

**Labels:** `maintenance`


## Description

### Description
Backport markdown doctest support from https://github.com/opensearch-project/sql/pull/4912 to `2.19-dev` branch

### Related Issues
Resolves merge conflicts blocking bot from creating auto backport PRs.  

### Check List
 - [n/a] New functionality has javadoc added.
- [n/a] API changes companion pull request [created](https://github.com/opensearch-project/opensearch-api-specification/blob/main/DEVELOPER_GUIDE.md).
- [n/a] Public documentation issue/PR [created](https://github.com/opensearch-project/documentation-website/issues/new/choose).

By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4937: [Backport 2.19-dev] Enhance doc and error message handling for `bins` on time-related fields

**URL:** https://github.com/opensearch-project/sql/pull/4937

**Author:** @ahkcs

**Created:** 2025-12-10T21:34:10Z

**State:** MERGED

**Merged:** 2025-12-15T16:28:26Z

**Changes:** +522 -1 (5 files)


## Description

Enhance doc and error message handling for `bins` on time-related field (#4713)

(cherry picked from commit ef4c51e0e15e6d8e5385ea3605c536775396fc39)



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4936: [Backport 2.19-dev] Time Unit Unification for bin/stats (#4450)

**URL:** https://github.com/opensearch-project/sql/pull/4936

**Author:** @ahkcs

**Created:** 2025-12-10T20:05:12Z

**State:** MERGED

**Merged:** 2025-12-11T02:22:11Z

**Changes:** +599 -60 (5 files)

**Labels:** `maintenance`


## Description

(cherry picked from commit 5bb274740685a57d1798e70ab43f6859e3d7ee81)



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4935: [Backport 3.4] Update 3.4 release Note (#4923)

**URL:** https://github.com/opensearch-project/sql/pull/4935

**Author:** @ahkcs

**Created:** 2025-12-10T18:56:39Z

**State:** MERGED

**Merged:** 2025-12-11T02:29:58Z

**Changes:** +157 -2 (2 files)

**Labels:** `skip-changelog`


## Description

Update 3.4 doc
(cherry picked from commit c87f99f5554e3e7edba2855bc2d0f219f4506c0d)



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4934: [Backport main] Update 3.4 release Note (#4923)

**URL:** https://github.com/opensearch-project/sql/pull/4934

**Author:** @ahkcs

**Created:** 2025-12-10T18:51:20Z

**State:** MERGED

**Merged:** 2025-12-11T02:29:31Z

**Changes:** +155 -0 (1 files)

**Labels:** `skip-changelog`


## Description

Update 3.4 doc
(cherry picked from commit c87f99f5554e3e7edba2855bc2d0f219f4506c0d)



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4933: Extract unified query context for shared config management

**URL:** https://github.com/opensearch-project/sql/pull/4933

**Author:** @dai-chen

**Created:** 2025-12-10T17:32:25Z

**State:** MERGED

**Merged:** 2025-12-17T22:54:26Z

**Changes:** +343 -215 (7 files)

**Labels:** `bug`, `maintenance`, `backport 2.19-dev`

**Assignees:** @dai-chen


## Description

### Description

This PR introduces `UnifiedQueryContext`, a reusable abstraction shared across unified query components (parser, planner, compiler, etc.). It centralizes configuration by constructing and bundling `CalcitePlanContext` and `Settings` into a single object. As a result, all unified query components can now read required configuration explicitly, resolving the configuration propagation issue tracked https://github.com/opensearch-project/sql/issues/4910.

### Related Issues

Resolves https://github.com/opensearch-project/sql/issues/4910.

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @LantaoJin on `api/README.md:None`


High-level Q: What session do you mean? I mean, how to define a session start and close? I didn't see any session management code at a glance.   


### @dai-chen on `api/README.md:None`


I was thinking about session in SQL/Spark. Since we've not clearly defined it, let me remove it to avoid confusion. Thanks!


### @dai-chen on `api/README.md:None`


Addressed in https://github.com/opensearch-project/sql/pull/4933/changes/f650fb5fc90150d973cd4ac0c6adbbf984792ef6.


## General Comments


_No general comments from humans_


---

# PR #4932: Add feedback reminder for CodeRabbit

**URL:** https://github.com/opensearch-project/sql/pull/4932

**Author:** @ykmr1224

**Created:** 2025-12-10T17:24:44Z

**State:** MERGED

**Merged:** 2025-12-11T22:01:28Z

**Changes:** +28 -0 (1 files)

**Labels:** `infrastructure`


## Description

### Description
- Add feedback reminder for CodeRabbit
  - When CodeRabbit made review comment, it automatically adds reminder message to leave feedback. `👋 Leave emoji reaction (👍/👎) to track effectiveness of CodeRabbit.`
  - Later we can take stats on how many comments got positive/negative feedback via Github API, and make improvement based on the result.

### Related Issues
n/a

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @dai-chen - APPROVED


Just wonder is this doable in Coderabbit config? Just feel this workflow is very specific for this small task.


## Review Comments


_No inline code comments from humans_


## General Comments


### @dai-chen


@ykmr1224 Also wondering is this knowledge base feature available to us? Instead of manual analysis, can we give feedback to Coderabbit directly? https://docs.coderabbit.ai/integrations/knowledge-base


### @ykmr1224


> Just wonder is this doable in Coderabbit config? Just feel this workflow is very specific for this small task.

Coderabbit don't have configuration for this kind of customization so far.

> @ykmr1224 Also wondering is this knowledge base feature available to us? Instead of manual analysis, can we give feedback to Coderabbit directly? https://docs.coderabbit.ai/integrations/knowledge-base

It is enabled and doable, but that relies on each developer giving appropriate feedback.
We should track overall effectiveness and improve that continuously.


### @dai-chen


> > Just wonder is this doable in Coderabbit config? Just feel this workflow is very specific for this small task.
> 
> Coderabbit don't have configuration for this kind of customization so far.
> 
> > @ykmr1224 Also wondering is this knowledge base feature available to us? Instead of manual analysis, can we give feedback to Coderabbit directly? https://docs.coderabbit.ai/integrations/knowledge-base
> 
> It is enabled and doable, but that relies on each developer giving appropriate feedback. We should track overall effectiveness and improve that continuously.

I agree. Either the knowledge base can separate team and personal preference, or we give permission to a small group. We can discuss offline. I'm just thinking we can maintain a single source of coding guidance, team knowledge between local Dev agent and this Review agent. Thanks! cc: @penghuo 


---

# PR #4930: [Backport 2.19-dev] Support composite aggregation paginating (#4884)

**URL:** https://github.com/opensearch-project/sql/pull/4930

**Author:** @LantaoJin

**Created:** 2025-12-10T10:01:39Z

**State:** MERGED

**Merged:** 2025-12-11T02:38:44Z

**Changes:** +1121 -532 (190 files)


## Description

(cherry picked from #4884 commit 9930665c372f433eea4aeb04b5a4cfcd51be3e9e)



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4929: Pushdown join with `max=n` option to TopHits aggregation

**URL:** https://github.com/opensearch-project/sql/pull/4929

**Author:** @LantaoJin

**Created:** 2025-12-10T09:09:26Z

**State:** MERGED

**Merged:** 2025-12-12T06:36:57Z

**Changes:** +170 -132 (27 files)

**Labels:** `enhancement`, `backport-manually`, `backport-failed`, `backport 2.19-dev`


## Description

### Description
Pushdown join with `max=n` option to TopHits aggregation:
- The right side subsearch with `max=n` will be converted to TopHits aggregation.
- For inner join, the `SortMergeJoin` may be converted to `HashJoin` by reordering the sides of join
- For non-inner join, the right side will be fully pushed down to DSL, rather than executing `WindowFunction` in memory.

### Related Issues
Resolves #4927 

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @qianheng-aws on `integ-test/src/test/java/org/opensearch/sql/calcite/remote/CalciteExplainIT.java:None`


Remove it?


### @LantaoJin on `integ-test/src/test/java/org/opensearch/sql/calcite/remote/CalciteExplainIT.java:None`


sure.


### @qianheng-aws on `integ-test/src/test/resources/expectedOutput/calcite_no_pushdown/explain_complex_sort_expr_pushdown_for_smj_w_max_option.yaml:23`


The behavior of system limit has changed from `limitation of source` to `limitation of the results after top hits`.

So if we cannot push down the window, it will scan all rows from the source. @LantaoJin 


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite_no_pushdown/explain_complex_sort_expr_pushdown_for_smj_w_max_option.yaml:23`


I corrected the behavior since the define of `plugins.ppl.join.subsearch_maxout` is

> The size configures the maximum of rows from subsearch to join against.


### @qianheng-aws on `integ-test/src/test/resources/expectedOutput/calcite_no_pushdown/explain_complex_sort_expr_pushdown_for_smj_w_max_option.yaml:23`


Can we ensure the window will always be pushed down? Otherwise it will get regression than before?


### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite_no_pushdown/explain_complex_sort_expr_pushdown_for_smj_w_max_option.yaml:23`


No if (1) the join keys contain text (not keyword); (2) the join keys contain expression (I am working on support #4789 which could resolve it)


## General Comments


### @LantaoJin


> <summary>core/src/main/java/org/opensearch/sql/calcite/CalciteRelNodeVisitor.java (1)</summary><blockquote>
> 
> `1323-1374`: **Address the gap between documentation and SEMI/ANTI join implementation.**
> 
> The documentation allows `max` option with `semi` and `anti` join types, but the code returns early for SEMI/ANTI joins (lines 1328-1332) before processing the `max` option and applying dedup/limit optimizations. This creates an inconsistency: users can specify `max` with SEMI/ANTI joins per the documented syntax, but it will be silently ignored.
> 
> Either remove the early return to enable `max` support for SEMI/ANTI joins, or add a validation error when `max` is specified with SEMI/ANTI, and update documentation to clarify the limitation.

@coderabbitai the `max` option takes no effect for `semi` and `anti` join types because `semi` and `anti` joins just use left side to filter the records in left side. So the join results in whatever max=1, max=2 or max=∞ are totally same.


---

# PR #4928: [Backport 2.19-dev] Support sort expression pushdown for SortMergeJoin(#4830)

**URL:** https://github.com/opensearch-project/sql/pull/4928

**Author:** @songkant-aws

**Created:** 2025-12-10T08:37:30Z

**State:** MERGED

**Merged:** 2025-12-11T07:35:34Z

**Changes:** +437 -133 (17 files)


## Description

### Description
Backport #4830 to 2.19-dev

### Related Issues

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4926: Replace duplicated aggregation logic with `aggregateWithTrimming()`

**URL:** https://github.com/opensearch-project/sql/pull/4926

**Author:** @ishaoxy

**Created:** 2025-12-10T06:36:20Z

**State:** MERGED

**Merged:** 2025-12-11T07:31:01Z

**Changes:** +65 -76 (10 files)

**Labels:** `backport-manually`, `backport-failed`, `backport 2.19-dev`, `bugFix`


## Description

### Description
 Just use `aggregateWithTrimming()` to avoid duplicating existing functionality.

### Related Issues
Resolves #4925 
<!-- List any other related issues here -->

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @LantaoJin on `core/src/main/java/org/opensearch/sql/calcite/CalciteRelNodeVisitor.java:1833`


@yuancu @songkant-aws we'd better not to call `context.relBuilder.aggregate` directly, instead, use `aggregateWithTrimming` to build aggregation in stack. I see some codes in `visitChart`, `rankByColumnSplit` and `visitPatterns`. Can you create a issue to replace?


### @LantaoJin on `core/src/main/java/org/opensearch/sql/calcite/CalciteRelNodeVisitor.java:1833`


Or co-auther with @ishaoxy to address them in this PR.


### @yuancu on `core/src/main/java/org/opensearch/sql/calcite/CalciteRelNodeVisitor.java:1833`


I did so because I needed to build multiple aggregations for the chart command. `aggregateWithTrimming` works on PPL's AST (composed of `UnresolvedPlan`) and creates RexNode AST, but I have already gone through this in the first aggregation. Therefore, I had to call `relBuilder.aggregate` the second time I created an aggregation to aggregate on RexNode.


## General Comments


_No general comments from humans_


---

# PR #4924: Remove all AccessController refs

**URL:** https://github.com/opensearch-project/sql/pull/4924

**Author:** @Swiddis

**Created:** 2025-12-09T20:27:42Z

**State:** MERGED

**Merged:** 2025-12-10T17:11:58Z

**Changes:** +377 -581 (25 files)

**Labels:** `maintenance`


## Description

### Description
Removes all uses of AccessController, which is deprecated since version 3.0. Finishing what #4900 started.

### Related Issues
N/A

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @Swiddis on `legacy/src/main/java/org/opensearch/sql/legacy/cursor/DefaultCursor.java:138`


@coderabbitai can you commit this?


### @Swiddis on `direct-query/src/main/java/org/opensearch/sql/directquery/transport/model/ExecuteDirectQueryActionResponse.java:112`


Will skip this, it's pre-existing behavior and I'm not sure what the impact would be to change it

Long-term: use a report wrapper #4919


### @Swiddis on `opensearch/src/main/java/org/opensearch/sql/opensearch/security/SecurityAccess.java:None`


Will remove this class entirely since it's just another doPrivileged wrapper


## General Comments


_No general comments from humans_


---

# PR #4923: Update 3.4 release Note

**URL:** https://github.com/opensearch-project/sql/pull/4923

**Author:** @ahkcs

**Created:** 2025-12-09T17:44:53Z

**State:** MERGED

**Merged:** 2025-12-09T21:16:26Z

**Changes:** +92 -10 (2 files)

**Labels:** `PPL`, `backport main`, `backport-failed`, `skip-changelog`, `backport 3.4`


## Description

### Description
Update 3.4 release Note

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @anasalkouz on `release-notes/opensearch-sql.release-notes-3.4.0.0.md:9`


Keep the message consistent with other features.
Change it to support `replace`


### @anasalkouz on `release-notes/opensearch-sql.release-notes-3.4.0.0.md:48`


Shall we add all new functions under the features section?


### @anasalkouz on `release-notes/opensearch-sql.release-notes-3.4.0.0.md:26`


Should be under features sections


### @anasalkouz on `release-notes/opensearch-sql.release-notes-3.4.0.0.md:27`


All new eval functions to be added under the feature section


### @ahkcs on `release-notes/opensearch-sql.release-notes-3.4.0.0.md:9`


Updated


### @ahkcs on `release-notes/opensearch-sql.release-notes-3.4.0.0.md:48`


Moved eval functions to features section


### @ahkcs on `release-notes/opensearch-sql.release-notes-3.4.0.0.md:26`


Updated


### @ahkcs on `release-notes/opensearch-sql.release-notes-3.4.0.0.md:27`


Moved eval functions to features section


## General Comments


### @ahkcs


Resolving the comments in a new PR, which will also be backported: 
https://github.com/opensearch-project/sql/pull/4939


---

# PR #4922: [DOC] Callout the aggregation result may be approximate

**URL:** https://github.com/opensearch-project/sql/pull/4922

**Author:** @LantaoJin

**Created:** 2025-12-09T09:43:15Z

**State:** MERGED

**Merged:** 2025-12-11T08:34:18Z

**Changes:** +58 -1 (3 files)

**Labels:** `documentation`, `backport 2.19-dev`


## Description

### Description
[DOC] Callout the aggregation result may be approximate

### Related Issues
Resolves #4915 

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @kylehounslow on `docs/user/ppl/cmd/stats.md:None`


Thanks for keeping our docs fresh!  

Note: If no output is provided, doctests might fail. Need to use "ignore" to omit from doctest. E.g. 
````
```ppl ignore
source=hits
| stats bucket_nullable=false count() as c by URL
| sort - c
| head 10
``` 
````

Else provide the expected output in a codeblock following the `ppl` block. Example: 
````
```ppl
search source=accounts | where age > 25 | fields firstname, lastname
```

Expected output:

```text
+-------------+------------+
| firstname   | lastname   |
|-------------+------------|
| Amber       | Duke       |
| Hattie      | Bond       |
+-------------+------------+
```
````


See https://github.com/opensearch-project/sql/blob/5f963a0a0ae29e20d84306d3423daf104cddeb42/docs/dev/testing-doctest.md#markdown-format-new---currently-for-docsuserppl-only


### @LantaoJin on `docs/user/ppl/cmd/stats.md:None`


Thanks! `ignore` added.


## General Comments


_No general comments from humans_


---

# PR #4920: [2.19-dev] Disable Calcite by default

**URL:** https://github.com/opensearch-project/sql/pull/4920

**Author:** @LantaoJin

**Created:** 2025-12-09T03:12:30Z

**State:** MERGED

**Merged:** 2025-12-09T06:50:34Z

**Changes:** +93 -1 (8 files)

**Labels:** `enhancement`


## Description

### Description
Disable Calcite by default in 2.19-dev

### Related Issues
Resolves #[Issue number to be closed when this PR is merged]
<!-- List any other related issues here -->

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4918: [Backport 2.19-dev] Support `split` eval function

**URL:** https://github.com/opensearch-project/sql/pull/4918

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-08T21:48:13Z

**State:** MERGED

**Merged:** 2025-12-10T23:27:05Z

**Changes:** +218 -0 (8 files)


## Description

Backport 5dca84f73315aafee61878c279bc7ba904c18be1 from #4814.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4917: [Backport 2.19-dev] Add unified query transpiler API

**URL:** https://github.com/opensearch-project/sql/pull/4917

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-08T20:02:24Z

**State:** MERGED

**Merged:** 2025-12-08T21:22:15Z

**Changes:** +238 -39 (8 files)


## Description

Backport d4daa34d83130429f44f14ecd703e070782c13c7 from #4871.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4916: [Backport 2.19-dev] Implement one-batch lookahead for index enumerators (#4345)

**URL:** https://github.com/opensearch-project/sql/pull/4916

**Author:** @Swiddis

**Created:** 2025-12-08T17:46:50Z

**State:** MERGED

**Merged:** 2025-12-10T09:36:39Z

**Changes:** +468 -74 (21 files)


## Description

### Description
Backport #4345 as there's no perf regression in OSB. In general, I'm confident that this helps it many query cases and doesn't overall hurt the general case.

Had to convert the Scanner away from record types because of JDK compatibility, should be no functionality diff.

### Related Issues
N/A

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @Swiddis on `prometheus/src/test/java/org/opensearch/sql/prometheus/storage/PrometheusStorageFactoryTest.java:133`


test.com just dropped out of DNS, leading to URI validation failures. Quick fix.


## General Comments


### @LantaoJin


@Swiddis I still see the compile errors in CI


---

# PR #4914: RexCall and RelDataType standardization for script push down

**URL:** https://github.com/opensearch-project/sql/pull/4914

**Author:** @qianheng-aws

**Created:** 2025-12-08T03:56:22Z

**State:** MERGED

**Merged:** 2025-12-12T02:48:16Z

**Changes:** +303 -79 (43 files)

**Labels:** `enhancement`, `backport-manually`, `backport-failed`, `pushdown`, `backport 2.19-dev`


## Description

### Description
This PR continues https://github.com/opensearch-project/sql/pull/4795 work, it includes change:
1. Implement RexCall standardization by using `RexNormalize.normalize`
2. Implement RelDataType standardization by widening the type, see details in `RexStandardizer::widenType`
3. Support Sarg literal value by expanding `SEARCH` to conjunction expressions.
4. Support decimal literal value by downgrading to double value.


### Related Issues
Resolves #4757 

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/storage/serde/RexStandardizer.java:109`


`helper.stack` here is an `ArrayDeque`, while used as a stack



### @LantaoJin on `integ-test/src/test/resources/expectedOutput/calcite/agg_case_cannot_push.yaml:9`


can you add a IT to verify the generated script with skip encoding via format=extended.


### @qianheng-aws on `integ-test/src/test/resources/expectedOutput/calcite/agg_case_cannot_push.yaml:9`


We have test `testSkipScriptEncodingOnExtendedFormat`. Do you mean set `format=extended` for  `agg_case_cannot_push`? 


### @qianheng-aws on `integ-test/src/test/resources/expectedOutput/calcite/agg_case_cannot_push.yaml:9`


Added in test case `testRexStandardizationForScript`

The script is formatted below, with several changes:
- `>=`   -> `<=`
- SEARCH -> AND(...)
- INT nullable=false -> BIGINT nullable=true
- CHAR[xxx] nullable=false -> VARCHAR nullable=true

```
{
  "op": {
    "name": "CASE",
    "kind": "CASE",
    "syntax": "SPECIAL"
  },
  "operands": [
    {
      "op": {
        "name": "<",
        "kind": "LESS_THAN",
        "syntax": "BINARY"
      },
      "operands": [
        {
          "dynamicParam": 0,
          "type": {
            "type": "BIGINT",
            "nullable": true
          }
        },
        {
          "dynamicParam": 1,
          "type": {
            "type": "BIGINT",
            "nullable": true
          }
        }
      ]
    },
    {
      "dynamicParam": 2,
      "type": {
        "type": "VARCHAR",
        "nullable": true,
        "precision": -1
      }
    },
    {
      "op": {
        "name": "AND",
        "kind": "AND",
        "syntax": "BINARY"
      },
      "operands": [
        {
          "op": {
            "name": "<=",
            "kind": "LESS_THAN_OR_EQUAL",
            "syntax": "BINARY"
          },
          "operands": [
            {
              "dynamicParam": 3,
              "type": {
                "type": "BIGINT",
                "nullable": true
              }
            },
            {
              "dynamicParam": 4,
              "type": {
                "type": "BIGINT",
                "nullable": true
              }
            }
          ]
        },
        {
          "op": {
            "name": "<=",
            "kind": "LESS_THAN_OR_EQUAL",
            "syntax": "BINARY"
          },
          "operands": [
            {
              "dynamicParam": 5,
              "type": {
                "type": "BIGINT",
                "nullable": true
              }
            },
            {
              "dynamicParam": 6,
              "type": {
                "type": "BIGINT",
                "nullable": true
              }
            }
          ]
        }
      ]
    },
    {
      "dynamicParam": 7,
      "type": {
        "type": "VARCHAR",
        "nullable": true,
        "precision": -1
      }
    },
    {
      "dynamicParam": 8,
      "type": {
        "type": "VARCHAR",
        "nullable": true,
        "precision": -1
      }
    }
  ]
}
```


### @qianheng-aws on `integ-test/src/test/java/org/opensearch/sql/calcite/remote/CalciteExplainIT.java:2136`


We should avoid reusing `FORMAT` parameter for  `EXPLAIN OPTION` and add a new parameter for it. `EXPLAIN OPTION` affects the content of this API while `FORMAT` only affects the format like JSON, CSV, YAML.

@coderabbitai  Could you create an issue to track this?


### @yuancu on `opensearch/src/main/java/org/opensearch/sql/opensearch/storage/serde/RexStandardizer.java:67`


I encountered a similar problem -- `Sarg` can be serialized but can not be properly deserialized. I addressed it by replacing `Sarg sarg = sargFromJson((Map) literal)` with `Sarg sarg = sargFromJson((Map) literal, type)` in `ExtendedRelJson.java`. Maybe it helps.


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/storage/serde/RexStandardizer.java:67`


The problem I met here is I cannot translate a Sarg literal into a java object by using `RexToLixTranslator.translateLiteral`.  Thus, we cannot generate a parameter for it.


### @qianheng-aws on `opensearch/src/main/java/org/opensearch/sql/opensearch/storage/serde/RexStandardizer.java:67`


From the implementation of `RexToLixTranslator `, it seems Sarg can only be used as literal in RexNode expression but not DynamicParams.


## General Comments


_No general comments from humans_


---

# PR #4912: Migrate PPL Documentation from RST to Markdown

**URL:** https://github.com/opensearch-project/sql/pull/4912

**Author:** @kylehounslow

**Created:** 2025-12-06T00:36:33Z

**State:** MERGED

**Merged:** 2025-12-09T21:52:43Z

**Changes:** +20383 -16782 (157 files)

**Labels:** `maintenance`


## Description

## Description

This PR converts all PPL documentation under `docs/user/ppl/` from reStructuredText to Markdown format, enabling automated export to the main [OpenSearch 
documentation website](https://docs.opensearch.org/latest/about/) at [opensearch-project/documentation-website](https://github.com/opensearch-project/documentation-website).

**Important Note: All existing doctest coverage has been migrated successfully and all existing GitHub-based documentation remains intact and fully functional. This change enables PPL documentation to appear on the main OpenSearch docs site while preserving the existing GitHub-based documentation experience. See demo below.**

### Live Demo: 
* GitHub docs: https://github.com/kylehounslow/sql/blob/feat/markdown-doctests/docs/user/ppl/index.md
* Main docs build: <TODO>  

### Why?
* Enables automatic export of PPL docs to main OpenSearch documentation site. Currently changes are made via manual copy/paste resulting in stale, inconsistent docs.  
* Improves discoverability of new/existing PPL commands and functionality.  
* Improves developer experience with clean, copy-able PPL code snippets.  

### Related Issues  
* https://github.com/opensearch-project/sql/issues/4854  
* https://github.com/opensearch-project/documentation-website/pull/11621

### Summary of Changes

#### Documentation Format Migration
* Converted 70+ RST files to Markdown across all PPL documentation sections
* Updated `docs/category.json` to reflect new file structure
* Removed shell prefixes and output from code blocks for clean copy-paste
* **GitHub documentation experience unchanged** - same content, same navigation, rendered by GitHub's native Markdown support

#### Doctest Changes
* Added `markdown_parser.py` to support doctest execution on Markdown code blocks
* Extended existing doctest framework to handle both RST and Markdown formats
* All existing tests pass with new parser

#### Export Tooling
* `export_to_docs_website.py` - Jekyll-compatible export to inject proper front-matter, etc while preserving exact docs structure from `docs/user/ppl`. 
  * Note: main docs page has already promoted SQL and PPL section to top-level to accommodate this: https://github.com/opensearch-project/documentation-website/pull/11621
* Conversion scripts (only run once. Kept for reference/re-use on remaining sql docs): 
  * `convert_rst_to_md.py` - Automated RST to Markdown conversion 
  * `fix_markdown_formatting.py` - Post-conversion cleanup and standardization to ensure proper Jekyll rendering 

### Future PR 
* Migrate remaining `docs/user/sql` to markdown. 

### Check List
 - [n/a] New functionality has javadoc added.
 - [n/a] New functionality has a user manual doc added.
- [n/a] API changes companion pull request [created](https://github.com/opensearch-project/opensearch-api-specification/blob/main/DEVELOPER_GUIDE.md).
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


### @ahkcs


UT failure due to test.com is down
Fix: https://github.com/opensearch-project/sql/pull/4916/commits/afcfbd951d4b387106047c363f770fc43ad021c2


---

# PR #4908: [Backport 2.19-dev] Error handling for dot-containing field names

**URL:** https://github.com/opensearch-project/sql/pull/4908

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-05T00:41:37Z

**State:** MERGED

**Merged:** 2025-12-05T05:56:45Z

**Changes:** +384 -7 (4 files)


## Description

Backport 8126367a787b121e4467e3467d9f158a421290c0 from #4907.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4907: Error handling for dot-containing field names

**URL:** https://github.com/opensearch-project/sql/pull/4907

**Author:** @ahkcs

**Created:** 2025-12-04T17:57:22Z

**State:** MERGED

**Merged:** 2025-12-05T00:12:19Z

**Changes:** +384 -7 (4 files)

**Labels:** `PPL`, `backport 2.19-dev`, `bugFix`


## Description

<h2>Summary</h2>
<p>Resolves <strong>#4896</strong> — <code inline="">ArrayIndexOutOfBoundsException</code> when querying an index containing <strong>malformed field names</strong> (e.g., <code inline="">"."</code>, <code inline="">".."</code>, <code inline="">".a"</code>, <code inline="">"a."</code>, <code inline="">"a..b"</code>) inside <strong>disabled object fields</strong>.</p>
<p>Disabled objects (<code inline="">"enabled": false</code>) bypass field-name validation, allowing malformed names to be indexed and subsequently causing crashes in the SQL/PPL engines.</p>
<hr>
<h2>Root Cause</h2>
<p><code inline="">OpenSearchExprValueFactory.JsonPath</code> constructs field paths using:</p>
<pre><code class="language-java">rawPath.split("\\.");
</code></pre>
<p>For malformed field names, <code inline="">split("\\.")</code> behaves unexpectedly:</p>

Field Name | Result of split() | Issue
-- | -- | --
".", ".." | [] (empty array) | dot-only → paths.get(0) crashes
".a" | ["", "a"] | leading dot → empty path segment
"a." | ["a"] (trailing empty removed) | trailing dot silently lost
"a..b" | ["a", "", "b"] | consecutive dots → empty segment





<!-- This is an auto-generated comment: release notes by coderabbit.ai -->

## Summary by CodeRabbit

## Release Notes

* **Bug Fixes**
  * Improved handling of queries on object fields containing malformed field names (dot-only names, leading/trailing dots, or consecutive dots). Invalid fields now return null while valid fields remain accessible.

* **Documentation**
  * Added documentation describing limitations when querying object fields with malformed field names and recommendations to avoid problematic naming patterns.

<sub>✏️ Tip: You can customize this high-level summary in your review settings.</sub>

<!-- end of auto-generated comment: release notes by coderabbit.ai -->



## Reviews


_No human reviews with comments_


## Review Comments


### @penghuo on `docs/user/ppl/limitations/limitations.rst:None`


> disabled object field,

remove disabled.

> PPL queries will return ``null`` for those specific fields.

PPL ignore malformed fieldname.


### @penghuo on `docs/user/ppl/limitations/limitations.rst:None`


malformed names field are ignored.


### @ahkcs on `docs/user/ppl/limitations/limitations.rst:None`


Updated


### @ahkcs on `docs/user/ppl/limitations/limitations.rst:None`


Updated


## General Comments


_No general comments from humans_


---

# PR #4902: [Backport 2.19-dev] Support timeouts for Calcite queries (#4857)

**URL:** https://github.com/opensearch-project/sql/pull/4902

**Author:** @Swiddis

**Created:** 2025-12-03T21:42:17Z

**State:** MERGED

**Merged:** 2025-12-05T05:57:49Z

**Changes:** +236 -45 (20 files)

**Labels:** `enhancement`


## Description

### Description
Backport #4857 to 2.19-dev

### Related Issues
N/A

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


### @LantaoJin


@Swiddis Can you set an appropriate commit message when you enable automatic merging next time?


---

# PR #4901: Adjust CodeRabbit review config

**URL:** https://github.com/opensearch-project/sql/pull/4901

**Author:** @ykmr1224

**Created:** 2025-12-03T21:28:19Z

**State:** MERGED

**Merged:** 2025-12-04T17:29:30Z

**Changes:** +6 -5 (1 files)

**Labels:** `infrastructure`


## Description

### Description
- Adjust CodeRabbit review config to enable auto review.
- Some more minor changes.

### Related Issues
https://github.com/opensearch-project/sql/issues/4889
https://github.com/opensearch-project/.github/issues/412

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4900: Remove doPrivileged call in Calcite script execution

**URL:** https://github.com/opensearch-project/sql/pull/4900

**Author:** @Swiddis

**Created:** 2025-12-03T19:35:46Z

**State:** MERGED

**Merged:** 2025-12-04T19:31:01Z

**Changes:** +2 -7 (1 files)

**Labels:** `maintenance`, `performance`, `calcite`


## Description

### Description
Seems to delete a major perf bottleneck: we create an access controller context for every individual document we process in a script, which involves a lot of stack trace traversal and locking for accessing that context. Curious what the breakage is if I just delete this controller step, since it passes tests locally. At least for the query I was interested in, it reduced the runtime from 70 seconds (2mil documents) to 4.

Better approach if we need it: move the privilege step to outside the core script loop.

Measured from slow query (big5 dataset):
```
source = big5
| where `agent.name` = 'filebeat'
| where `@timestamp` >= '2023-01-01 00:00:00' and `@timestamp` <= '2023-01-02 00:00:00'
| where `metrics.size` > 1000 and `metrics.size` != 5000
| stats count(`agent.name`)
```

Before (70s/query):
<img width="2155" height="1032" alt="image" src="https://github.com/user-attachments/assets/5451dc06-cd36-4f11-af6e-c79c804aba02" />

After (4s/query):
<img width="1627" height="1038" alt="image" src="https://github.com/user-attachments/assets/3b8fb4f6-5c48-46ec-b2b7-c3e310f63897" />


### Related Issues
N/A

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @dai-chen - APPROVED


Thanks for the changes! If I recall right, this is mostly for action whitelisted in plugin-security.policy?


## Review Comments


_No inline code comments from humans_


## General Comments


### @songkant-aws


Grreat! I remember somehow 2.19 still needs it. But it was removed in OpenSearch since 3.x version.


---

# PR #4895: [Backport 2.19-dev] [BugFix] Fix Memory Exhaustion for Multiple Filtering Operations in PPL

**URL:** https://github.com/opensearch-project/sql/pull/4895

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-02T21:41:24Z

**State:** MERGED

**Merged:** 2025-12-02T23:38:55Z

**Changes:** +291 -126 (37 files)


## Description

Backport 52fe8aa5bd19e8008e4c11bcbd2ea69946b5724e from #4841.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4891: [Backport 2.19-dev] Add hashCode() and equals() to the value class of ExprJavaType

**URL:** https://github.com/opensearch-project/sql/pull/4891

**Author:** @app/opensearch-trigger-bot

**Created:** 2025-12-02T00:46:19Z

**State:** MERGED

**Merged:** 2025-12-02T02:28:45Z

**Changes:** +88 -1 (3 files)


## Description

Backport 96370bfa573831d046db5f5c7029113460cbbb11 from #4885.



## Reviews


_No human reviews with comments_


## Review Comments


_No inline code comments from humans_


## General Comments


_No general comments from humans_


---

# PR #4890: Add config for CodeRabbit review

**URL:** https://github.com/opensearch-project/sql/pull/4890

**Author:** @ykmr1224

**Created:** 2025-12-01T23:59:46Z

**State:** MERGED

**Merged:** 2025-12-02T17:27:18Z

**Changes:** +185 -0 (2 files)

**Labels:** `infrastructure`


## Description

### Description
- Add config files for CodeRabbit review (AI review assistant)
  - Requested use of Amazon Q, but there were discussion in LF and they decided to use CodeRabbit. (https://github.com/opensearch-project/.github/issues/412)
- Disable auto review for now (enable once we establish configuration).

### Related Issues
https://github.com/opensearch-project/sql/issues/4889
https://github.com/opensearch-project/.github/issues/412

### Check List
By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
For more information on following Developer Certificate of Origin and signing off your commits, please check [here](https://github.com/opensearch-project/sql/blob/main/CONTRIBUTING.md#developer-certificate-of-origin).



## Reviews


### @RyanL1997 - APPROVED


Hi @ykmr1224, thanks for the change. LGTM. Left a minor question.


## Review Comments


### @RyanL1997 on `.coderabbit.yaml:22`


Nice, I think we can also start exercising this in our PR template when we initially creating PR.


### @RyanL1997 on `.rules/REVIEW_GUIDELINES.md:48`


Is this rule specific for command development?


### @ykmr1224 on `.rules/REVIEW_GUIDELINES.md:48`


No, this is generic for any code change in this repository.


### @Swiddis on `.coderabbit.yaml:69`


Not sure if I like this setting, maybe others like it though?

Usually when responding to AI comments the only audience is other reviewers (e.g. "this comment doesn't apply" or "implemented"), I'm not sure I see the value of the AI reply


## General Comments


_No general comments from humans_


---

