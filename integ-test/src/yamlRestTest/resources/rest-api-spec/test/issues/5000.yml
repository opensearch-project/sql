setup:
  - do:
      query.settings:
        body:
          transient:
            plugins.calcite.enabled: true
  - do:
      indices.create:
        index: bom
        body:
          mappings:
            properties:
              parent:
                type: keyword
              component:
                type: keyword
              quantity:
                type: integer
  - do:
      bulk:
        index: bom
        refresh: true
        body:
          - '{"index": {}}'
          - '{"parent": "Bike", "component": "Frame", "quantity": 1}'
          - '{"index": {}}'
          - '{"parent": "Bike", "component": "Wheels", "quantity": 2}'
          - '{"index": {}}'
          - '{"parent": "Bike", "component": "Drivetrain", "quantity": 1}'
          - '{"index": {}}'
          - '{"parent": "Wheels", "component": "Spokes", "quantity": 32}'
          - '{"index": {}}'
          - '{"parent": "Wheels", "component": "Tire", "quantity": 1}'
          - '{"index": {}}'
          - '{"parent": "Drivetrain", "component": "Crankset", "quantity": 1}'
          - '{"index": {}}'
          - '{"parent": "Drivetrain", "component": "Chain", "quantity": 1}'
          - '{"index": {}}'
          - '{"parent": "Crankset", "component": "Pedal", "quantity": 2}'

---
teardown:
  - do:
      query.settings:
        body:
          transient:
            plugins.calcite.enabled : false

---
"union recursive bom quantities":
  - skip:
      features:
        - headers
        - allowed_warnings
  - do:
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: |
            source=bom
            | where parent='Bike'
            | fields component, quantity
            | union recursive name=bom_qty [
                source=bom
                | join left=b right=t on b.parent = t.component bom_qty
                | eval quantity=b.quantity * t.quantity
                | fields component, quantity
              ]
            | where component not in [source=bom | fields parent]

  - match: { total: 5 }
  - match: { size: 5 }
  - match: { "schema": [ { "name": "component", "type": "string" }, { "name": "quantity", "type": "int" } ] }
  - match:
      "datarows":
        - ["Chain", 1]
        - ["Frame", 1]
        - ["Pedal", 2]
        - ["Spokes", 64]
        - ["Tire", 2]
