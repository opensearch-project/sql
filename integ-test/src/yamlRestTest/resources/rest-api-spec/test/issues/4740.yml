setup:
  - do:
      indices.create:
        index: test_binning_4740
        body:
          mappings:
            properties:
              "@timestamp":
                type: date
              "age":
                type: keyword
              "balance":
                type: keyword
              "name":
                type: keyword
  - do:
      bulk:
        index: test_binning_4740
        refresh: true
        body:
          - '{"index":{}}'
          - '{"@timestamp":"2024-01-01T00:00:00.000Z","age":"25","balance":"1000.0","name":"Alice"}'
          - '{"index":{}}'
          - '{"@timestamp":"2024-01-01T00:05:00.000Z","age":"30","balance":"2000.0","name":"Bob"}'
          - '{"index":{}}'
          - '{"@timestamp":"2024-01-01T00:10:00.000Z","age":"35","balance":"3000.0","name":"Charlie"}'
          - '{"index":{}}'
          - '{"@timestamp":"2024-01-01T00:15:00.000Z","age":"40","balance":"4000.0","name":"David"}'
          - '{"index":{}}'
          - '{"@timestamp":"2024-01-01T00:20:00.000Z","age":"45","balance":"5000.0","name":"Eve"}'

# TODO: Enable after fixing https://github.com/opensearch-project/sql/issues/4973
#  problem: string minus string in the generated plan
#---
#"bin with numeric field using WIDTH_BUCKET - issue 4740":
#  - skip:
#      features:
#        - headers
#        - allowed_warnings
#  - do:
#      allowed_warnings:
#        - 'Loading the fielddata on the _id field is deprecated and will be removed in future versions. If you require sorting or aggregating on this field you should also include the id in the body of your documents, and map this field as a keyword field that has [doc_values] enabled'
#      headers:
#        Content-Type: 'application/json'
#      ppl:
#        body:
#          query: source=test_binning_4740 | bin age bins=3 | stats count() by age | sort age
#
#  - match: { "schema": [ { "name": "count()", "type": "bigint" }, { "name": "age", "type": "string" } ] }
#  - match: { "datarows": [ [ 1, "20-30" ], [ 2, "30-40" ], [ 2, "40-50" ] ] }

---
"bin with numeric span using SPAN_BUCKET - issue 4740":
  - skip:
      features:
        - headers
        - allowed_warnings
  - do:
      allowed_warnings:
        - 'Loading the fielddata on the _id field is deprecated and will be removed in future versions. If you require sorting or aggregating on this field you should also include the id in the body of your documents, and map this field as a keyword field that has [doc_values] enabled'
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=test_binning_4740 | bin age span=10 | stats count() by age | sort age

  - match: { "schema": [ { "name": "count()", "type": "bigint" }, { "name": "age", "type": "string" } ] }
  - match: { "datarows": [ [ 1, "20-30" ], [ 2, "30-40" ], [ 2, "40-50" ] ] }

# TODO: Enable after fixing https://github.com/opensearch-project/sql/issues/4973
#  problem: string minus string in the generated plan
#---
#"bin with minspan using MINSPAN_BUCKET - issue 4740":
#  - skip:
#      features:
#        - headers
#        - allowed_warnings
#  - do:
#      allowed_warnings:
#        - 'Loading the fielddata on the _id field is deprecated and will be removed in future versions. If you require sorting or aggregating on this field you should also include the id in the body of your documents, and map this field as a keyword field that has [doc_values] enabled'
#      headers:
#        Content-Type: 'application/json'
#      ppl:
#        body:
#          query: source=test_binning_4740 | bin balance minspan=1000 | stats count() by balance | sort balance
#
#  - match: { "schema": [ { "name": "count()", "type": "bigint" }, { "name": "balance", "type": "string" } ] }
#  - match: { "datarows": [ [ 1, "1000-2000" ], [ 1, "2000-3000" ], [ 1, "3000-4000" ], [ 1, "4000-5000" ], [ 1, "5000-6000" ] ] }

# TODO: Enable after fixing https://github.com/opensearch-project/sql/issues/4973
#   problem: cast string to number in the generated code
#---
#"bin with start and end using RANGE_BUCKET - issue 4740":
#  - skip:
#      features:
#        - headers
#        - allowed_warnings
#  - do:
#      allowed_warnings:
#        - 'Loading the fielddata on the _id field is deprecated and will be removed in future versions. If you require sorting or aggregating on this field you should also include the id in the body of your documents, and map this field as a keyword field that has [doc_values] enabled'
#      headers:
#        Content-Type: 'application/json'
#      ppl:
#        body:
#          query: source=test_binning_4740 | bin age start=20 end=50 | stats count() by age | sort age
#
#  - match: { "schema": [ { "name": "count()", "type": "bigint" }, { "name": "age", "type": "string" } ] }
#  - match: { "datarows": [ [ 1, "20-30" ], [ 2, "30-40" ], [ 2, "40-50" ] ] }

# TODO: Enable after fixing https://github.com/opensearch-project/sql/issues/4973
#  problem: string minus string in the generated plan
#---
#"bin with default binning (no parameters) on string field - issue 4740":
#  - skip:
#      features:
#        - headers
#        - allowed_warnings
#  - do:
#      allowed_warnings:
#        - 'Loading the fielddata on the _id field is deprecated and will be removed in future versions. If you require sorting or aggregating on this field you should also include the id in the body of your documents, and map this field as a keyword field that has [doc_values] enabled'
#      headers:
#        Content-Type: 'application/json'
#      ppl:
#        body:
#          query: source=test_binning_4740 | bin balance | stats count() by balance | sort balance
#
#  - match: { "schema": [ { "name": "count()", "type": "bigint" }, { "name": "balance", "type": "string" } ] }
#  - match: { "datarows": [ [ 1, "1000.0-2000.0" ], [ 1, "2000.0-3000.0" ], [ 1, "3000.0-4000.0" ], [ 1, "4000.0-5000.0" ], [ 1, "5000.0-6000.0" ] ] }
