calcite:
  logical: |
    LogicalSystemLimit(fetch=[10000], type=[QUERY_SIZE_LIMIT])
      LogicalProject(age2=[$2])
        LogicalFilter(condition=[<=($3, 1)])
          LogicalProject(avg_age=[$0], state=[$1], age2=[$2], _row_number_dedup_=[ROW_NUMBER() OVER (PARTITION BY $2)])
            LogicalFilter(condition=[IS NOT NULL($2)])
              LogicalProject(avg_age=[$0], state=[$1], age2=[+($0, 2)])
                LogicalSort(sort0=[$1], dir0=[ASC-nulls-first])
                  LogicalProject(avg_age=[$2], state=[$0], city=[$1])
                    LogicalAggregate(group=[{0, 1}], avg_age=[AVG($2)])
                      LogicalProject(state=[$7], city=[$5], age=[$8])
                        LogicalFilter(condition=[>($8, 30)])
                          CalciteLogicalIndexScan(table=[[OpenSearch, opensearch-sql_test_index_account]])
  physical: |
    EnumerableCalc(expr#0..1=[{inputs}], age2=[$t0])
      EnumerableLimit(fetch=[10000])
        EnumerableCalc(expr#0..1=[{inputs}], expr#2=[1], expr#3=[<=($t1, $t2)], proj#0..1=[{exprs}], $condition=[$t3])
          EnumerableWindow(window#0=[window(partition {0} rows between UNBOUNDED PRECEDING and CURRENT ROW aggs [ROW_NUMBER()])])
            EnumerableCalc(expr#0=[{inputs}], expr#1=[2], expr#2=[+($t0, $t1)], expr#3=[IS NOT NULL($t0)], $0=[$t2], $condition=[$t3])
              CalciteEnumerableIndexScan(table=[[OpenSearch, opensearch-sql_test_index_account]], PushDownContext=[[FILTER->>($2, 30), AGGREGATION->rel#:LogicalAggregate.NONE.[](input=RelSubset#,group={0, 1},avg_age=AVG($2)), PROJECT->[avg_age, state], SORT->[1 ASC FIRST], PROJECT->[avg_age]], OpenSearchRequestBuilder(sourceBuilder={"from":0,"size":0,"timeout":"1m","query":{"range":{"age":{"from":30,"to":null,"include_lower":false,"include_upper":true,"boost":1.0}}},"aggregations":{"composite_buckets":{"composite":{"size":1000,"sources":[{"state":{"terms":{"field":"state.keyword","missing_bucket":true,"missing_order":"first","order":"asc"}}},{"city":{"terms":{"field":"city.keyword","missing_bucket":true,"missing_order":"first","order":"asc"}}}]},"aggregations":{"avg_age":{"avg":{"field":"age"}}}}}}, requestedTotalSize=2147483647, pageSize=null, startFrom=0)])
  extended: |+
    public org.apache.calcite.linq4j.Enumerable bind(final org.apache.calcite.DataContext root) {
      final org.opensearch.sql.opensearch.storage.scan.CalciteEnumerableIndexScan v1stashed = (org.opensearch.sql.opensearch.storage.scan.CalciteEnumerableIndexScan) root.get("v1stashed");
      final org.apache.calcite.linq4j.Enumerable _inputEnumerable = v1stashed.scan();
      final org.apache.calcite.linq4j.AbstractEnumerable source = new org.apache.calcite.linq4j.AbstractEnumerable(){
        public org.apache.calcite.linq4j.Enumerator enumerator() {
          return new org.apache.calcite.linq4j.Enumerator(){
              public final org.apache.calcite.linq4j.Enumerator inputEnumerator = _inputEnumerable.enumerator();
              public void reset() {
                inputEnumerator.reset();
              }

              public boolean moveNext() {
                while (inputEnumerator.moveNext()) {
                  if ((Double) inputEnumerator.current() != null) {
                    return true;
                  }
                }
                return false;
              }

              public void close() {
                inputEnumerator.close();
              }

              public Object current() {
                return (Double) inputEnumerator.current() == null ? null : Double.valueOf(((Double) inputEnumerator.current()).doubleValue() + (double) 2);
              }

            };
        }

      };
      int prevStart;
      int prevEnd;
      final java.util.Comparator comparator = new java.util.Comparator(){
        public int compare(Double v0, Double v1) {
          int c;
          return 0;
        }

        public int compare(Object o0, Object o1) {
          return this.compare((Double) o0, (Double) o1);
        }

      };
      final org.apache.calcite.runtime.SortedMultiMap multiMap = new org.apache.calcite.runtime.SortedMultiMap();
      source.foreach(new org.apache.calcite.linq4j.function.Function1() {
        public Object apply(Double v) {
          Double key = v;
          multiMap.putMulti(key, v);
          return null;
        }
        public Object apply(Object v) {
          return apply(
            (Double) v);
        }
      }
      );
      final java.util.Iterator iterator = multiMap.arrays(comparator);
      final java.util.ArrayList _list = new java.util.ArrayList(
        multiMap.size());
      Long a0w0 = (Long) null;
      while (iterator.hasNext()) {
        final Object[] _rows = (Object[]) iterator.next();
        prevStart = -1;
        prevEnd = 2147483647;
        for (int i = 0; i < _rows.length; (++i)) {
          if (i != prevEnd) {
            int actualStart = i < prevEnd ? 0 : prevEnd + 1;
            prevEnd = i;
            a0w0 = Long.valueOf(((Number)org.apache.calcite.linq4j.tree.Primitive.of(long.class).numberValueRoundDown((i - 0 + 1))).longValue());
          }
          _list.add(new Object[] {
            (Double) _rows[i],
            a0w0});
        }
      }
      multiMap.clear();
      final org.apache.calcite.linq4j.Enumerable _inputEnumerable0 = org.apache.calcite.linq4j.Linq4j.asEnumerable(_list);
      final org.apache.calcite.linq4j.AbstractEnumerable child = new org.apache.calcite.linq4j.AbstractEnumerable(){
        public org.apache.calcite.linq4j.Enumerator enumerator() {
          return new org.apache.calcite.linq4j.Enumerator(){
              public final org.apache.calcite.linq4j.Enumerator inputEnumerator = _inputEnumerable0.enumerator();
              public void reset() {
                inputEnumerator.reset();
              }

              public boolean moveNext() {
                while (inputEnumerator.moveNext()) {
                  if (org.apache.calcite.runtime.SqlFunctions.toLong(((Object[]) inputEnumerator.current())[1]) <= $L4J$C$_Number_org_apache_calcite_linq4j_tree_Primitive_of_long_class_358aa52b) {
                    return true;
                  }
                }
                return false;
              }

              public void close() {
                inputEnumerator.close();
              }

              public Object current() {
                final Object[] current = (Object[]) inputEnumerator.current();
                final Object input_value = current[0];
                final Object input_value0 = current[1];
                return new Object[] {
                    input_value,
                    input_value0};
              }

              static final long $L4J$C$_Number_org_apache_calcite_linq4j_tree_Primitive_of_long_class_358aa52b = ((Number)org.apache.calcite.linq4j.tree.Primitive.of(long.class).numberValueRoundDown(1)).longValue();
            };
        }

      };
      final org.apache.calcite.linq4j.Enumerable _inputEnumerable1 = child.take(10000);
      return new org.apache.calcite.linq4j.AbstractEnumerable(){
          public org.apache.calcite.linq4j.Enumerator enumerator() {
            return new org.apache.calcite.linq4j.Enumerator(){
                public final org.apache.calcite.linq4j.Enumerator inputEnumerator = _inputEnumerable1.enumerator();
                public void reset() {
                  inputEnumerator.reset();
                }

                public boolean moveNext() {
                  return inputEnumerator.moveNext();
                }

                public void close() {
                  inputEnumerator.close();
                }

                public Object current() {
                  return (Double) ((Object[]) inputEnumerator.current())[0];
                }

              };
          }

        };
    }


    public Class getElementType() {
      return java.lang.Double.class;
    }
