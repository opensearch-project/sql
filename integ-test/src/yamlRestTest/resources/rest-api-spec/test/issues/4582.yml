setup:
  - do:
      query.settings:
        body:
          transient:
            plugins.calcite.enabled : true
  - do:
      indices.create:
        index: test_timechart_4582
        body:
          mappings:
            properties:
              "@timestamp":
                type: date_nanos
              severityNumber:
                type: long
              severityText:
                type: keyword
              body:
                type: text
  - do:
      bulk:
        index: test_timechart_4582
        refresh: true
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2024-01-15T10:30:04.567890123Z", "severityNumber": 9, "severityText": "INFO", "body": "Info message"}'
          - '{"index": {}}'
          - '{"@timestamp": "2024-01-15T10:30:05.567890123Z", "severityNumber": 13, "severityText": "WARN", "body": "Warning message"}'
          - '{"index": {}}'
          - '{"@timestamp": "2024-01-15T10:30:06.567890123Z", "severityNumber": 17, "severityText": "ERROR", "body": "Error message"}'
          - '{"index": {}}'
          - '{"@timestamp": "2024-01-15T10:30:07.567890123Z", "severityNumber": 21, "severityText": "FATAL", "body": "Fatal message"}'
          - '{"index": {}}'
          - '{"@timestamp": "2024-01-15T10:30:08.567890123Z", "severityNumber": 24, "severityText": "FATAL4", "body": "Fatal4 message"}'
          - '{"index": {}}'
          - '{"@timestamp": "2024-01-15T10:30:09.567890123Z", "severityNumber": 23, "severityText": "DEBUG", "body": "Debug message"}'
          - '{"index": {}}'
          - '{"@timestamp": "2024-01-15T10:30:10.567890123Z", "severityNumber": 20, "severityText": "TRACE", "body": "Trace message"}'
          - '{"index": {}}'
          - '{"@timestamp": "2024-01-15T10:30:11.567890123Z", "severityNumber": 22, "severityText": "CUSTOM", "body": "Custom message"}'

---
teardown:
  - do:
      query.settings:
        body:
          transient:
            plugins.calcite.enabled : false

---
"timechart max aggregation with limit should not sum OTHER values":
  - skip:
      features:
        - headers
        - allowed_warnings
  - do:
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=test_timechart_4582 | timechart limit=1 span=10seconds max(severityNumber) by severityText

  - match: { total: 3 }
  - match: { "schema": [{"name": "@timestamp", "type": "timestamp"}, {"name": "severityText", "type": "string"}, {"name": "max(severityNumber)", "type": "bigint"}] }
  - match: { "datarows": [["2024-01-15 10:30:00", "FATAL4", 24], ["2024-01-15 10:30:00", "OTHER", 23], ["2024-01-15 10:30:10", "OTHER",22]] }

---
"timechart min aggregation with limit should not sum OTHER values":
  - skip:
      features:
        - headers
        - allowed_warnings
  - do:
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=test_timechart_4582 | timechart limit=2 span=1d min(severityNumber) by severityText

  - match: { total: 3 }
  - match: { "schema": [{"name": "@timestamp", "type": "timestamp"}, {"name": "severityText", "type": "string"}, {"name": "min(severityNumber)", "type": "bigint"}] }
  - match: { "datarows": [["2024-01-15 00:00:00", "INFO", 9], ["2024-01-15 00:00:00", "OTHER", 17], ["2024-01-15 00:00:00", "WARN", 13]] }

---
"timechart earliest aggregation with limit should not sum OTHER values":
  - skip:
      features:
        - headers
        - allowed_warnings
  - do:
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=test_timechart_4582 | timechart limit=2 span=30seconds earliest(@timestamp) by severityText

  - match: { total: 3 }
  - match: { "schema": [{"name": "@timestamp", "type": "timestamp"}, {"name": "severityText", "type": "string"}, {"name": "earliest(@timestamp)", "type": "timestamp"}] }
  - match: { "datarows": [
    ["2024-01-15 10:30:00", "INFO", "2024-01-15 10:30:04.567890123"],
    ["2024-01-15 10:30:00", "OTHER", "2024-01-15 10:30:06.567890123"],
    ["2024-01-15 10:30:00", "WARN", "2024-01-15 10:30:05.567890123"]] }

---
"timechart count aggregation with limit should sum OTHER values":
  - skip:
      features:
        - headers
        - allowed_warnings
  - do:
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=test_timechart_4582 | timechart limit=3 span=1min count() by severityText

  - match: { total: 4 }
  - match: { "schema": [{"name": "@timestamp", "type": "timestamp"}, {"name": "severityText", "type": "string"}, {"name": "count", "type": "bigint"}] }
  - match: { "datarows": [["2024-01-15 10:30:00", "CUSTOM", 1], ["2024-01-15 10:30:00", "DEBUG", 1], ["2024-01-15 10:30:00", "ERROR", 1], ["2024-01-15 10:30:00", "OTHER", 5]] }
