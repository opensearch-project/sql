setup:
  - do:
      query.settings:
        body:
          transient:
            plugins.calcite.enabled : true

  - do:
      indices.create:
        index: accounts
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
          mappings:
            properties:
              email:
                type: text

---
teardown:
  - do:
      query.settings:
        body:
          transient:
            plugins.calcite.enabled : false

---
"Enhanced error handling for underscores in rex regex capture group names":
  - skip:
      features:
        - headers
        - allowed_warnings
  - do:
      bulk:
        index: accounts
        refresh: true
        body:
          - '{"index": {}}'
          - '{"email": "john@example.com"}'

  - do:
      catch: bad_request
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=accounts | rex field=email ".+@(?<domain_name>.+)" | fields email, domain_name

  - match: { $body: "{\n  \"error\": {\n    \"reason\": \"Invalid Query\",\n    \"details\": \"Underscores are not permitted in Java Regex capture group names\",\n    \"type\": \"IllegalArgumentException\"\n  },\n  \"status\": 400\n}" }

---
"Enhanced error handling for underscores in parse regex capture group names":
  - skip:
      features:
        - headers
        - allowed_warnings
  - do:
      bulk:
        index: accounts
        refresh: true
        body:
          - '{"index": {}}'
          - '{"email": "john@example.com"}'

  - do:
      catch: bad_request
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=accounts | parse email ".+@(?<host_name>.+)" | fields email, host_name

  - match: { $body: "{\n  \"error\": {\n    \"reason\": \"Invalid Query\",\n    \"details\": \"Underscores are not permitted in Java Regex capture group names\",\n    \"type\": \"IllegalArgumentException\"\n  },\n  \"status\": 400\n}" }

---
"Rex command should work with valid group names without underscores":
  - skip:
      features:
        - headers
        - allowed_warnings
  - do:
      bulk:
        index: accounts
        refresh: true
        body:
          - '{"index": {}}'
          - '{"email": "john@example.com"}'

  - do:
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=accounts | rex field=email ".+@(?<domain>.+)" | fields email, domain

  - match: { total: 1 }
  - match: { datarows: [["john@example.com", "example.com"]] }

---
"Parse command should work with valid group names without underscores":
  - skip:
      features:
        - headers
        - allowed_warnings
  - do:
      bulk:
        index: accounts
        refresh: true
        body:
          - '{"index": {}}'
          - '{"email": "john@example.com"}'

  - do:
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=accounts | parse email ".+@(?<host>.+)" | fields email, host

  - match: { total: 1 }
  - match: { datarows: [["john@example.com", "example.com"]] }
