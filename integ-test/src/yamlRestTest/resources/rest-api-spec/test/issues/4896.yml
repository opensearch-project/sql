# Issue: https://github.com/opensearch-project/sql/issues/4896
# ArrayIndexOutOfBoundsException when querying index with dot-only field name in disabled object
#
# Root cause: When a document has a field name that is just "." (a single dot),
# the JsonPath constructor's split("\\.") returns an empty array, causing
# paths.get(0) to crash with ArrayIndexOutOfBoundsException.
#
# This can happen when an index has a disabled object field (enabled: false),
# which allows storing documents without validating inner field names.
#
# Fix: The query engine now tolerates corrupt/invalid field names by returning null
# for those fields (with a warning log), allowing the rest of the document to be
# processed normally.

setup:
  - do:
      query.settings:
        body:
          transient:
            plugins.calcite.enabled: true
  # Create index with disabled object field
  - do:
      indices.create:
        index: test_disabled_object_4896
        body:
          mappings:
            properties:
              log:
                type: object
                enabled: false
              "@timestamp":
                type: date
              message:
                type: text

  # Index document with "." field name inside disabled object
  # OpenSearch allows this because the object is disabled (no validation of inner fields)
  - do:
      index:
        index: test_disabled_object_4896
        id: 1
        refresh: true
        body:
          "@timestamp": "2025-11-26T17:10:00.000Z"
          message: "test message"
          log:
            ".": "problematic value"

---
teardown:
  - do:
      query.settings:
        body:
          transient:
            plugins.calcite.enabled: false
  - do:
      indices.delete:
        index: test_disabled_object_4896

---
"Query index with dot-only field name in disabled object should succeed with valid fields":
  - skip:
      features:
        - headers
  # Before the fix: ArrayIndexOutOfBoundsException: Index 0 out of bounds for length 0
  # After the fix: Query succeeds, invalid field returns null with a warning log,
  # and valid fields (@timestamp, message) are returned normally
  # Query valid fields - should succeed
  - do:
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=test_disabled_object_4896 | fields @timestamp, message
  - match: { "total": 1 }
  - match: { "datarows.0.0": "2025-11-26 17:10:00" }
  - match: { "datarows.0.1": "test message" }

  # Query all fields including log - should succeed without crash
  # The log field with invalid "." field name will have null for that field
  - do:
      headers:
        Content-Type: 'application/json'
      ppl:
        body:
          query: source=test_disabled_object_4896
  - match: { "total": 1 }
